<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Attendance - NEU</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- QRCode library (davidshimjs/qrcodejs) with fallback CDNs -->
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
  <script>
    // Fallback CDN for QRCode library if primary fails
    if (typeof QRCode === 'undefined') {
      document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>');
    }
  </script>
  <!-- Chart.js for Analytics Dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {}
      }
    }
  </script>
  <style>
    .code-display { font-family: 'Courier New', monospace; letter-spacing: 0.3em; }
    @media print { .no-print { display: none !important; } .print-only { display: block !important; } }
    .print-only { display: none; }
    .offline-banner { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .late-badge { animation: latePulse 2s infinite; }
    @keyframes latePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .qr-fallback { background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; text-align: center; }
    .qr-fallback-text { color: #6b7280; font-size: 0.875rem; }
    .modal-backdrop { background: rgba(0,0,0,0.5); }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen transition-colors duration-300">

<!-- Offline Banner -->
<div id="offlineBanner" class="hidden fixed top-0 left-0 right-0 bg-amber-500 text-white text-center py-2 text-sm font-medium z-50 offline-banner no-print">
  <span>You are offline. Changes may not be saved.</span>
</div>

<!-- Modal Container -->
<div id="modalContainer"></div>

<div id="app" class="p-4 max-w-4xl mx-auto">
  <div class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400 mx-auto mb-4"></div>
      <p class="text-gray-600 dark:text-gray-300">Loading...</p>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAubMSBm8SMIyxFnTIpzAx73F4cZJhA9fU",
  authDomain: "neu-attendance.firebaseapp.com",
  databaseURL: "https://neu-attendance-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "neu-attendance",
  storageBucket: "neu-attendance.firebasestorage.app",
  messagingSenderId: "330504462930",
  appId: "1:330504462930:web:44bb4a75740935d379b58b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const CODE_REFRESH_SECONDS = 120;
const CODE_GRACE_PERIOD = 180;
const RECENTLY_EXPIRED_WINDOW = 30; // Accept codes that expired within the last 30 seconds
const SESSION_STORAGE_KEY = 'neu_attendance_session';
const DARK_MODE_KEY = 'neu_attendance_dark_mode';
const STUDENT_INFO_KEYS = {
  STUDENT_ID: 'neu_student_id',
  STUDENT_NAME: 'neu_student_name',
  STUDENT_EMAIL: 'neu_student_email'
};
const INSTRUCTOR_PIN = '230782';
const DEFAULT_LATE_THRESHOLD_MINUTES = 10;
const COUNTDOWN_WARNING_SECONDS = 10;

let state = {
  mode: null,
  session: null,
  currentCode: '',
  timeLeft: CODE_REFRESH_SECONDS,
  attendance: [],
  failedAttempts: [],
  teacherLocation: null,
  studentLocation: null,
  locationError: null,
  deviceId: null,
  codeInterval: null,
  attendanceListener: null,
  failedListener: null,
  sessionListener: null,
  showFailed: true,
  isOnline: navigator.onLine,
  isRecovering: false,
  darkMode: false,
  pinVerified: false,
  lateThreshold: DEFAULT_LATE_THRESHOLD_MINUTES,
  sessionHistory: [],
  showHistory: false,
  selectedFailedAttempts: new Set(),
  audioContext: null,
  lastWarningTime: 0,
  savedStudentInfo: null,
  showSavedInfoBanner: false,
  showFullForm: false,
  isReopenedSession: false,
  qrCodeAvailable: typeof QRCode !== 'undefined',
  cachedQRCode: null, // { code: 'ABC123', dataUrl: 'data:image/...' }
  // AC8: Session History Management
  selectedHistorySession: null,
  selectedSessionAttendance: [],
  showAllHistory: false,
  historyFilter: '',
  // AC9: Edit Attendance Records
  showAddStudentModal: false,
  showEditStudentModal: false,
  editingStudent: null,
  showAddNoteModal: false,
  noteTargetStudent: null,
  // Student Attendance Lookup (P4-03)
  lookupStudentId: '',
  lookupResults: [],
  lookupLoading: false,
  lookupError: null,
  // Analytics Dashboard
  showAnalytics: false,
  analyticsData: null,
  analyticsLoading: false,
  analyticsDateStart: '',
  analyticsDateEnd: '',
  analyticsSortColumn: 'rate',
  analyticsSortDirection: 'desc',
  trendChart: null,
  sessionChart: null
};

// Check if QRCode library is available
function isQRCodeAvailable() {
  return typeof QRCode !== 'undefined' && QRCode !== null;
}

// Initialize audio context for sounds
function initAudioContext() {
  if (!state.audioContext) {
    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  return state.audioContext;
}

// Play success beep sound
function playSuccessSound() {
  try {
    const ctx = initAudioContext();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);

    oscillator.frequency.value = 880; // A5 note
    oscillator.type = 'sine';

    gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);

    oscillator.start(ctx.currentTime);
    oscillator.stop(ctx.currentTime + 0.3);
  } catch (e) {
    console.warn('Could not play success sound:', e);
  }
}

// Countdown warning - vibrate only (no sound to avoid disruption)
function playWarningBeep() {
  try {
    // Use vibration pattern: short-pause-short for countdown warning
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100]);
    }
  } catch (e) {
    console.warn('Could not trigger warning vibration:', e);
  }
}

// Trigger vibration
function triggerVibration(pattern = [200]) {
  try {
    if (navigator.vibrate) {
      navigator.vibrate(pattern);
    }
  } catch (e) {
    console.warn('Vibration not supported:', e);
  }
}

// Dark mode functions
function loadDarkMode() {
  try {
    const saved = localStorage.getItem(DARK_MODE_KEY);
    if (saved !== null) {
      state.darkMode = saved === 'true';
    } else {
      // Check system preference
      state.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
    }
    applyDarkMode();
  } catch (e) {
    console.warn('Could not load dark mode preference:', e);
  }
}

function applyDarkMode() {
  if (state.darkMode) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
}

function toggleDarkMode() {
  state.darkMode = !state.darkMode;
  applyDarkMode();
  try {
    localStorage.setItem(DARK_MODE_KEY, state.darkMode.toString());
  } catch (e) {
    console.warn('Could not save dark mode preference:', e);
  }
  render();
}

// Student info persistence functions
function saveStudentInfo(info) {
  try {
    localStorage.setItem(STUDENT_INFO_KEYS.STUDENT_ID, info.studentId);
    localStorage.setItem(STUDENT_INFO_KEYS.STUDENT_NAME, info.studentName);
    localStorage.setItem(STUDENT_INFO_KEYS.STUDENT_EMAIL, info.studentEmail);
    return true;
  } catch (e) {
    console.warn('Could not save student info:', e);
    return false;
  }
}

function loadStudentInfo() {
  try {
    const studentId = localStorage.getItem(STUDENT_INFO_KEYS.STUDENT_ID);
    const studentName = localStorage.getItem(STUDENT_INFO_KEYS.STUDENT_NAME);
    const studentEmail = localStorage.getItem(STUDENT_INFO_KEYS.STUDENT_EMAIL);

    if (!studentId || !studentName || !studentEmail) {
      return null;
    }

    return { studentId, studentName, studentEmail };
  } catch (e) {
    console.warn('Could not load student info:', e);
    return null;
  }
}

function clearStudentInfo() {
  try {
    localStorage.removeItem(STUDENT_INFO_KEYS.STUDENT_ID);
    localStorage.removeItem(STUDENT_INFO_KEYS.STUDENT_NAME);
    localStorage.removeItem(STUDENT_INFO_KEYS.STUDENT_EMAIL);
    state.savedStudentInfo = null;
    state.showSavedInfoBanner = false;
    return true;
  } catch (e) {
    console.warn('Could not clear student info:', e);
    return false;
  }
}

// Quick Confirm for returning students (AC6.2)
// Allows one-tap attendance confirmation when student has saved info and code from QR
function showFullStudentForm() {
  state.showFullForm = true;
  render();
}

async function quickConfirmAttendance() {
  const savedInfo = state.savedStudentInfo;
  const urlParams = getUrlParams();
  const code = urlParams.code;

  if (!savedInfo || !code) {
    showFullStudentForm();
    return;
  }

  const btn = document.getElementById('submitBtn');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Confirming...';
  }

  // Use saved student info for submission
  const studentId = savedInfo.studentId;
  const studentName = savedInfo.studentName;
  const studentEmail = savedInfo.studentEmail;
  const deviceId = state.deviceId;

  // Validate saved info
  if (!studentId || !studentName || !studentEmail || !deviceId) {
    showMessage('Please enter your details', 'error');
    showFullStudentForm();
    return;
  }

  // Continue with the same submission logic as submitAttendance
  const sessionsRef = db.ref('sessions');
  const sessionsSnapshot = await sessionsRef.orderByChild('isActive').equalTo(true).once('value');
  const sessionsData = sessionsSnapshot.val();

  if (!sessionsData) {
    showMessage('No active session. Please wait for instructor.', 'error');
    if (btn) { btn.disabled = false; btn.textContent = '‚úì Confirm Attendance'; }
    return;
  }

  const sessionId = Object.keys(sessionsData)[0];
  const session = sessionsData[sessionId];

  // Verify code (current or previous within grace period)
  const now = Date.now();
  const codeAge = (now - session.codeGeneratedAt) / 1000;
  const isCurrentCode = code.toUpperCase() === session.code.toUpperCase();
  const isPreviousCode = session.previousCode && code.toUpperCase() === session.previousCode.toUpperCase() && codeAge < CODE_GRACE_PERIOD;

  if (!isCurrentCode && !isPreviousCode) {
    await logFailedAttempt(sessionId, { studentId, studentName, studentEmail, deviceId, code, reason: 'Invalid or expired code', location: state.studentLocation });
    showMessage('Invalid or expired code. Try again.', 'error');
    if (btn) { btn.disabled = false; btn.textContent = '‚úì Confirm Attendance'; }
    return;
  }

  // Check location if available
  if (state.studentLocation && session.location) {
    const distance = haversineDistance(state.studentLocation.latitude, state.studentLocation.longitude, session.location.latitude, session.location.longitude);
    if (distance > session.radius) {
      await logFailedAttempt(sessionId, { studentId, studentName, studentEmail, deviceId, code, reason: `Too far: ${Math.round(distance)}m`, location: state.studentLocation, distance: Math.round(distance) });
      showMessage(`You're ${Math.round(distance)}m away (limit: ${session.radius}m). Your attempt has been logged for instructor review.`, 'error');
      if (btn) { btn.disabled = false; btn.textContent = '‚úì Confirm Attendance'; }
      return;
    }
  }

  // Check for duplicates
  const attendanceRef = db.ref(`attendance/${sessionId}`);
  const existingAttendance = await attendanceRef.once('value');
  const attendanceData = existingAttendance.val() || {};

  for (const key in attendanceData) {
    if (attendanceData[key].studentId === studentId) {
      showMessage('You have already checked in!', 'error');
      if (btn) { btn.disabled = false; btn.textContent = '‚úì Confirm Attendance'; }
      return;
    }
    if (attendanceData[key].deviceId === deviceId) {
      await logFailedAttempt(sessionId, { studentId, studentName, studentEmail, deviceId, code, reason: 'Device already used', location: state.studentLocation });
      showMessage('This device has already been used for check-in.', 'error');
      if (btn) { btn.disabled = false; btn.textContent = '‚úì Confirm Attendance'; }
      return;
    }
  }

  // Determine if late
  const sessionStart = new Date(session.createdAt).getTime();
  const lateThreshold = (session.lateThresholdMinutes || DEFAULT_LATE_THRESHOLD_MINUTES) * 60 * 1000;
  const isLate = now > (sessionStart + lateThreshold);
  const isLateRejoin = session.isReopenedForLate || false;

  // Success - record attendance
  await attendanceRef.push({
    studentId,
    studentName,
    studentEmail,
    deviceId,
    timestamp: new Date().toISOString(),
    location: state.studentLocation || null,
    codeUsed: code.toUpperCase(),
    isLate,
    isLateRejoin,
    quickConfirm: true
  });

  // Play success sound
  playSuccessBeep();

  showMessage(`‚úì Attendance confirmed for ${session.className}!${isLate ? ' (Late)' : ''} You can close this page.`, 'success');
  if (btn) { btn.disabled = false; btn.textContent = '‚úì Confirmed!'; }
}

// Offline detection
function updateOnlineStatus() {
  state.isOnline = navigator.onLine;
  const banner = document.getElementById('offlineBanner');
  if (banner) {
    banner.classList.toggle('hidden', state.isOnline);
  }
  const app = document.getElementById('app');
  if (app) {
    app.style.paddingTop = state.isOnline ? '' : '40px';
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Firebase connection state
db.ref('.info/connected').on('value', (snapshot) => {
  const connected = snapshot.val();
  if (connected === false && state.isOnline) {
    const banner = document.getElementById('offlineBanner');
    if (banner) {
      banner.classList.remove('hidden');
      banner.innerHTML = '<span>Reconnecting to server...</span>';
    }
  } else if (connected === true) {
    const banner = document.getElementById('offlineBanner');
    if (banner && state.isOnline) {
      banner.classList.add('hidden');
    }
  }
});

function getBaseUrl() {
  return window.location.href.split('?')[0].split('#')[0];
}

function getUrlParams() {
  const params = new URLSearchParams(window.location.search);
  return { mode: params.get('mode'), code: params.get('code') };
}

function generateCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
}

async function generateDeviceId() {
  const components = [
    navigator.userAgent,
    navigator.language,
    screen.width + 'x' + screen.height,
    screen.colorDepth,
    new Date().getTimezoneOffset(),
    navigator.hardwareConcurrency || 'unknown',
    navigator.platform
  ];
  const str = components.join('|');
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return 'DEV-' + Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const p1 = lat1 * Math.PI / 180;
  const p2 = lat2 * Math.PI / 180;
  const dp = (lat2 - lat1) * Math.PI / 180;
  const dl = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dp/2) * Math.sin(dp/2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dl/2) * Math.sin(dl/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function getLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) { reject(new Error('Geolocation not supported')); return; }
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy }),
      err => reject(err),
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  });
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2, '0')}`;
}

// Check if a check-in is late
function isLateCheckIn(checkInTimestamp, sessionStartTimestamp, thresholdMinutes) {
  const checkInTime = new Date(checkInTimestamp).getTime();
  const sessionStart = new Date(sessionStartTimestamp).getTime();
  const thresholdMs = thresholdMinutes * 60 * 1000;
  return (checkInTime - sessionStart) > thresholdMs;
}

// Session persistence for recovery
function saveSessionToStorage(sessionId) {
  try {
    sessionStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify({
      sessionId,
      savedAt: Date.now()
    }));
  } catch (e) {
    console.warn('Could not save session to storage:', e);
  }
}

function loadSessionFromStorage() {
  try {
    const data = sessionStorage.getItem(SESSION_STORAGE_KEY);
    if (data) {
      const parsed = JSON.parse(data);
      if (Date.now() - parsed.savedAt < 4 * 60 * 60 * 1000) {
        return parsed.sessionId;
      }
    }
  } catch (e) {
    console.warn('Could not load session from storage:', e);
  }
  return null;
}

function clearSessionStorage() {
  try {
    sessionStorage.removeItem(SESSION_STORAGE_KEY);
  } catch (e) {
    console.warn('Could not clear session storage:', e);
  }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Dark mode toggle button HTML
function renderDarkModeToggle() {
  return `
    <button onclick="toggleDarkMode()" class="fixed top-4 right-4 z-40 p-2 rounded-full bg-white dark:bg-gray-700 shadow-lg hover:shadow-xl transition-all no-print" title="Toggle dark mode">
      ${state.darkMode
        ? '<svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg>'
        : '<svg class="w-6 h-6 text-gray-700" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>'
      }
    </button>`;
}

function render() {
  const app = document.getElementById('app');
  let content = renderDarkModeToggle();

  if (!state.mode) {
    content += renderModeSelection();
  } else if (state.mode === 'teacher') {
    if (!state.pinVerified) {
      content += renderPinEntry();
    } else {
      content += renderTeacherView();
      // Only regenerate QR codes when the code actually changes
      if (state.session && state.currentCode && (!state.cachedQRCode || state.cachedQRCode.code !== state.currentCode)) {
        setTimeout(generateQRCodes, 100);
      }
    }
  } else if (state.mode === 'student') {
    content += renderStudentView();
  } else if (state.mode === 'lookup') {
    content += renderLookupView();
  }

  app.innerHTML = content;
  updateOnlineStatus();
  renderModals();
}

function renderPinEntry() {
  return `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md">
        <button onclick="setMode(null)" class="mb-4 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium">‚Üê Back</button>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Instructor Access</h2>
        <p class="text-gray-500 dark:text-gray-400 text-sm mb-6">Enter your PIN to access instructor mode</p>
        <div id="pinMessage"></div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">PIN</label>
            <input type="password" id="instructorPin" maxlength="10" placeholder="Enter PIN"
              class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white text-center text-2xl tracking-widest"
              onkeypress="if(event.key === 'Enter') verifyPin()">
          </div>
          <button onclick="verifyPin()" class="w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold text-lg transition-colors">
            Access Instructor Mode
          </button>
        </div>
      </div>
    </div>`;
}

function verifyPin() {
  const enteredPin = document.getElementById('instructorPin').value;
  const msgDiv = document.getElementById('pinMessage');

  if (enteredPin === INSTRUCTOR_PIN) {
    state.pinVerified = true;
    render();
    tryRecoverSession();
    setTimeout(generateSetupQRCodes, 100);
  } else {
    msgDiv.innerHTML = '<div class="mb-4 p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg">Incorrect PIN</div>';
  }
}

function renderModeSelection() {
  return `
    <div class="flex items-center justify-center min-h-screen">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md">
        <h1 class="text-3xl font-bold text-center text-gray-800 dark:text-white mb-2">Quick Attendance</h1>
        <p class="text-gray-500 dark:text-gray-400 text-center mb-8">NEU Geolocation-verified System</p>
        <div class="space-y-4">
          <button onclick="setMode('teacher')" class="w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold text-lg transition-colors">I'm the Instructor</button>
          <button onclick="setMode('student')" class="w-full py-4 px-6 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-semibold text-lg transition-colors">I'm a Student</button>
          <button onclick="setMode('lookup')" class="w-full py-3 px-6 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-xl font-medium transition-colors">View My Attendance</button>
        </div>
        <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-4">Or scan a QR code:</p>
          <div class="grid grid-cols-2 gap-4">
            <div class="text-center"><div id="qr-teacher" class="bg-indigo-50 dark:bg-indigo-900/30 p-3 rounded-lg inline-block"></div><p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Instructor</p></div>
            <div class="text-center"><div id="qr-student" class="bg-emerald-50 dark:bg-emerald-900/30 p-3 rounded-lg inline-block"></div><p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Student</p></div>
          </div>
        </div>
      </div>
    </div>`;
}

function renderTeacherView() {
  if (state.isRecovering) {
    return `
      <div class="flex items-center justify-center min-h-screen">
        <div class="text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400 mx-auto mb-4"></div>
          <p class="text-gray-600 dark:text-gray-300">Recovering session...</p>
        </div>
      </div>`;
  }

  // Show history view
  if (state.showHistory) {
    return renderHistoryView();
  }

  // Show analytics view
  if (state.showAnalytics) {
    return renderAnalyticsView();
  }

  if (!state.session) {
    return `
      <div class="pt-8">
        <button onclick="setMode(null)" class="mb-4 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium no-print">‚Üê Back</button>
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Start Attendance Session</h2>
            <button onclick="state.showAnalytics = true; loadAnalyticsData(); render();" class="px-4 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/50 font-medium text-sm">
              Analytics
            </button>
            <button onclick="state.showHistory = true; loadSessionHistory(); render();" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium text-sm">
              View History
            </button>
          </div>
          <div class="space-y-4">
            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Class Name</label><input type="text" id="className" maxlength="100" placeholder="e.g., Business Communication - Section A" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white"></div>
            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Classroom Radius: <span id="radiusValue">300</span>m</label><input type="range" id="radius" min="20" max="500" value="300" oninput="document.getElementById('radiusValue').textContent=this.value" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"><p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Students must be within this distance</p></div>
            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Late Threshold: <span id="lateValue">${state.lateThreshold}</span> minutes</label><input type="range" id="lateThreshold" min="5" max="30" value="${state.lateThreshold}" oninput="document.getElementById('lateValue').textContent=this.value; state.lateThreshold=parseInt(this.value);" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"><p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Check-ins after this time will be marked as late</p></div>
            <div id="locationStatus" class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-sm text-gray-600 dark:text-gray-300">Your location will be captured when you start</div>
            <button onclick="startSession()" id="startBtn" class="w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold text-lg transition-colors">Start Session</button>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 mt-6">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">QR Codes for Class</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Print or display these:</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="text-center p-4 border-2 border-dashed border-emerald-300 dark:border-emerald-600 rounded-xl"><div id="qr-student-large" class="inline-block bg-white p-2 rounded"></div><p class="font-semibold text-emerald-700 dark:text-emerald-400 mt-2">Student Check-in</p></div>
            <div class="text-center p-4 border-2 border-dashed border-indigo-300 dark:border-indigo-600 rounded-xl"><div id="qr-teacher-large" class="inline-block bg-white p-2 rounded"></div><p class="font-semibold text-indigo-700 dark:text-indigo-400 mt-2">Instructor Panel</p></div>
          </div>
          <button onclick="window.print()" class="mt-4 w-full py-2 px-4 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg font-medium no-print">Print QR Codes</button>
        </div>
      </div>`;
  }

  const connectionStatus = state.isOnline ? '' : '<span class="ml-2 px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded text-xs">Offline</span>';
  const lateCount = state.attendance.filter(a => a.isLate).length;
  const onTimeCount = state.attendance.length - lateCount;
  const hasSelectedFailed = state.selectedFailedAttempts.size > 0;
  const allFailedSelected = state.failedAttempts.length > 0 && state.selectedFailedAttempts.size === state.failedAttempts.length;
  const reopenedBadge = state.isReopenedSession ? '<span class="ml-2 px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded text-xs">Reopened for Late Check-ins</span>' : '';

  return `
    <div class="pt-8 space-y-6">
      <div class="flex justify-between items-center no-print">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white">${escapeHtml(state.session.className)}${connectionStatus}${reopenedBadge}</h2>
        <div class="flex gap-2">
          <button onclick="state.showAnalytics = true; loadAnalyticsData(); render();" class="px-4 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/50 font-medium text-sm">
            Analytics
          </button>
          <button onclick="state.showHistory = true; loadSessionHistory(); render();" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium text-sm">
            History
          </button>
          <button onclick="endSession()" class="px-4 py-2 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 font-medium">${state.isReopenedSession ? 'Close' : 'End Session'}</button>
        </div>
      </div>

      <!-- Code Display -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center">
        <p class="text-gray-500 dark:text-gray-400 mb-2">Current Code</p>
        <div class="code-display text-6xl md:text-8xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">${escapeHtml(state.currentCode)}</div>
        <div class="flex items-center justify-center gap-2 text-gray-500 dark:text-gray-400 mb-6">
          <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
          <span>New code in <strong id="countdown-timer" class="${state.timeLeft <= COUNTDOWN_WARNING_SECONDS ? 'text-red-600 dark:text-red-400' : ''}">${formatTime(state.timeLeft)}</strong></span>
        </div>
        <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-xl p-6 inline-block">
          <p class="text-emerald-700 dark:text-emerald-400 font-semibold mb-3">Scan to Check In (includes code)</p>
          <div id="qr-student-checkin" class="bg-white p-3 rounded-lg inline-block">${
            state.cachedQRCode && state.cachedQRCode.code === state.currentCode
              ? `<img src="${state.cachedQRCode.dataUrl}" width="180" height="180" alt="QR Code">`
              : ''
          }</div>
        </div>
      </div>

      <!-- Stats Summary -->
      <div class="grid grid-cols-3 gap-4 no-print">
        <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-xl p-4 text-center">
          <p class="text-3xl font-bold text-emerald-700 dark:text-emerald-400">${onTimeCount}</p>
          <p class="text-sm text-emerald-600 dark:text-emerald-500">On Time</p>
        </div>
        <div class="bg-orange-50 dark:bg-orange-900/30 rounded-xl p-4 text-center">
          <p class="text-3xl font-bold text-orange-700 dark:text-orange-400">${lateCount}</p>
          <p class="text-sm text-orange-600 dark:text-orange-500">Late</p>
        </div>
        <div class="bg-amber-50 dark:bg-amber-900/30 rounded-xl p-4 text-center">
          <p class="text-3xl font-bold text-amber-700 dark:text-amber-400">${state.failedAttempts.length}</p>
          <p class="text-sm text-amber-600 dark:text-amber-500">Failed</p>
        </div>
      </div>

      <!-- Attendance List -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 no-print">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Attendance (${state.attendance.length})</h3>
          <button onclick="exportCSV()" class="px-4 py-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-900/50 font-medium text-sm ${state.attendance.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}">Export CSV</button>
        </div>
        ${state.attendance.length === 0 ? '<p class="text-gray-400 dark:text-gray-500 text-center py-6">Waiting for students...</p>' : `
          <div class="overflow-x-auto max-h-64 overflow-y-auto">
            <table class="w-full text-sm">
              <thead class="sticky top-0 bg-white dark:bg-gray-800">
                <tr class="border-b dark:border-gray-700">
                  <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">#</th>
                  <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Student ID</th>
                  <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Name</th>
                  <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Email</th>
                  <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Time</th>
                  <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Loc</th>
                  <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Status</th>
                </tr>
              </thead>
              <tbody>
                ${state.attendance.map((a, i) => `
                  <tr class="border-b border-gray-100 dark:border-gray-700 ${i === state.attendance.length - 1 ? 'bg-emerald-50 dark:bg-emerald-900/20' : ''}">
                    <td class="py-2 text-gray-400 dark:text-gray-500">${i + 1}</td>
                    <td class="py-2 font-mono text-gray-800 dark:text-gray-200">${escapeHtml(a.studentId)}</td>
                    <td class="py-2 text-gray-800 dark:text-gray-200">${escapeHtml(a.studentName)}</td>
                    <td class="py-2 text-gray-500 dark:text-gray-400 text-xs">${escapeHtml(a.email || '')}</td>
                    <td class="py-2 text-gray-500 dark:text-gray-400">${new Date(a.timestamp).toLocaleTimeString()}</td>
                    <td class="py-2 text-center">
                      ${a.locationProvided !== false && a.location ? '<span class="text-emerald-600 dark:text-emerald-400" title="Location verified">‚úì</span>' : '<span class="text-amber-500 dark:text-amber-400" title="No location data">‚Äî</span>'}
                    </td>
                    <td class="py-2">
                      ${a.isLate
                        ? '<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded text-xs font-medium late-badge">Late</span>'
                        : '<span class="px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded text-xs font-medium">On Time</span>'
                      }
                      ${a.manuallyApproved ? '<span class="ml-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded text-xs">Manual</span>' : ''}
                      ${a.lateCheckIn ? '<span class="ml-1 px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded text-xs">Rejoined</span>' : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>

      <!-- Failed Attempts -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 no-print border-l-4 border-amber-400 dark:border-amber-500">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Failed Attempts (${state.failedAttempts.length})</h3>
          <div class="flex gap-2">
            ${state.failedAttempts.length > 0 ? `
              <button onclick="exportFailedCSV()" class="px-3 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded-lg hover:bg-amber-200 dark:hover:bg-amber-900/50 text-sm font-medium">
                Export Failed
              </button>
            ` : ''}
            <button onclick="state.showFailed = !state.showFailed; render();" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
              ${state.showFailed ? 'Hide' : 'Show'}
            </button>
          </div>
        </div>
        ${!state.showFailed ? '' : state.failedAttempts.length === 0 ? '<p class="text-gray-400 dark:text-gray-500 text-center py-4">No failed attempts</p>' : `
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Students who tried to check in but failed verification. You can manually approve if appropriate.</p>

          <!-- Bulk Actions -->
          <div class="flex gap-2 mb-4">
            <button onclick="toggleSelectAllFailed()" class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 text-sm font-medium">
              ${allFailedSelected ? 'Deselect All' : 'Select All'}
            </button>
            ${hasSelectedFailed ? `
              <button onclick="bulkApproveSelected()" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium">
                Approve Selected (${state.selectedFailedAttempts.size})
              </button>
            ` : ''}
          </div>

          <div class="space-y-3 max-h-80 overflow-y-auto">
            ${state.failedAttempts.map((f, i) => `
              <div class="border border-amber-200 dark:border-amber-700 rounded-lg p-4 bg-amber-50 dark:bg-amber-900/20 ${state.selectedFailedAttempts.has(f.firebaseKey) ? 'ring-2 ring-indigo-500' : ''}">
                <div class="flex items-start gap-3">
                  <input type="checkbox"
                    ${state.selectedFailedAttempts.has(f.firebaseKey) ? 'checked' : ''}
                    onchange="toggleFailedSelection('${f.firebaseKey}')"
                    class="mt-1 h-4 w-4 text-indigo-600 rounded border-gray-300 dark:border-gray-600 focus:ring-indigo-500">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="font-semibold text-gray-800 dark:text-gray-200">${escapeHtml(f.studentName)}</span>
                      <span class="font-mono text-sm text-gray-500 dark:text-gray-400">${escapeHtml(f.studentId)}</span>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">${escapeHtml(f.email || 'No email')}</p>
                    <div class="flex flex-wrap gap-2 text-xs">
                      <span class="px-2 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded">${escapeHtml(f.reason)}</span>
                      <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded">Distance: ${f.distance}m</span>
                      <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded">Allowed: ${f.allowedRadius}m</span>
                      <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded">${new Date(f.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Device: ${escapeHtml(f.deviceId)}</p>
                  </div>
                  <button onclick="approveStudent('${f.firebaseKey}')" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium whitespace-nowrap">
                    Approve
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    </div>

    <!-- Print version -->
    <div class="print-only p-8">
      <h1 class="text-2xl font-bold mb-2">${escapeHtml(state.session.className)}</h1>
      <p class="text-gray-600 mb-4">${new Date().toLocaleDateString()} - ${state.attendance.length} students (${lateCount} late)</p>
      <table class="w-full text-sm border-collapse">
        <thead><tr class="border-b-2"><th class="text-left py-2">#</th><th class="text-left py-2">Student ID</th><th class="text-left py-2">Name</th><th class="text-left py-2">Email</th><th class="text-left py-2">Time</th><th class="text-left py-2">Status</th></tr></thead>
        <tbody>${state.attendance.map((a, i) => `<tr class="border-b"><td class="py-1">${i + 1}</td><td class="py-1">${escapeHtml(a.studentId)}</td><td class="py-1">${escapeHtml(a.studentName)}</td><td class="py-1">${escapeHtml(a.email || '')}</td><td class="py-1">${new Date(a.timestamp).toLocaleTimeString()}</td><td class="py-1">${a.isLate ? 'Late' : 'On Time'}</td></tr>`).join('')}</tbody>
      </table>
    </div>`;
}

function renderHistoryView() {
  // If viewing a specific session's details (AC8)
  if (state.selectedHistorySession) {
    return renderSessionDetailView();
  }

  // Filter sessions based on search and showAllHistory toggle
  let filteredSessions = state.sessionHistory;
  if (state.historyFilter) {
    const filter = state.historyFilter.toLowerCase();
    filteredSessions = filteredSessions.filter(s => 
      s.className.toLowerCase().includes(filter) ||
      new Date(s.createdAt).toLocaleDateString().includes(filter)
    );
  }
  if (!state.showAllHistory) {
    const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    filteredSessions = filteredSessions.filter(s => new Date(s.createdAt).getTime() > sevenDaysAgo);
  }

  return `
    <div class="pt-8">
      <button onclick="state.showHistory = false; state.selectedHistorySession = null; render();" class="mb-4 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium no-print">‚Üê Back to Dashboard</button>
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Session History</h2>
          <label class="flex items-center gap-2 text-sm">
            <input type="checkbox" ${state.showAllHistory ? 'checked' : ''} onchange="state.showAllHistory = this.checked; render();" class="rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
            <span class="text-gray-600 dark:text-gray-400">Show All Sessions</span>
          </label>
        </div>
        
        <!-- Search/Filter (AC8) -->
        <div class="mb-4">
          <input type="text" placeholder="Search by class name or date..." value="${escapeHtml(state.historyFilter)}" 
            oninput="state.historyFilter = this.value; render();"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
        </div>
        
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">${state.showAllHistory ? 'All sessions' : 'Sessions from the last 7 days'}. Click a session to view details.</p>
        ${filteredSessions.length === 0
          ? '<p class="text-gray-400 dark:text-gray-500 text-center py-8">No sessions found</p>'
          : `
            <div class="space-y-4">
              ${filteredSessions.map(session => {
                const isEnded = !!session.endedAt;
                const daysSinceCreated = Math.floor((Date.now() - new Date(session.createdAt).getTime()) / (1000 * 60 * 60 * 24));
                const canReopen = isEnded && daysSinceCreated <= 7;
                return `
                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer" onclick="viewSessionDetails('${session.id}')">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <h3 class="font-semibold text-gray-800 dark:text-white">${escapeHtml(session.className)}</h3>
                      <p class="text-sm text-gray-500 dark:text-gray-400">${new Date(session.createdAt).toLocaleDateString()} ${new Date(session.createdAt).toLocaleTimeString()}</p>
                      ${session.endedAt ? '<p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Ended: ' + new Date(session.endedAt).toLocaleTimeString() + '</p>' : '<p class="text-xs text-green-500 mt-1">Currently Active</p>'}
                      ${session.lateCount ? '<p class="text-xs text-orange-600 dark:text-orange-400 mt-1">' + session.lateCount + ' late arrivals</p>' : ''}
                    </div>
                    <div class="text-right ml-4">
                      <p class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${session.attendanceCount || 0}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">students</p>
                      ${canReopen ? '<button onclick="event.stopPropagation(); reopenSession(\'' + session.id + '\')" class="mt-2 px-3 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-900/50 text-sm font-medium">Reopen for Late</button>' : ''}
                    </div>
                  </div>
                </div>
              `}).join('')}
            </div>
          `
        }
      </div>
    </div>`;
}

function renderStudentView() {
  const locDisplay = state.studentLocation
    ? `${state.studentLocation.lat.toFixed(6)}, ${state.studentLocation.lng.toFixed(6)}`
    : 'Acquiring...';
  const accuracyDisplay = state.studentLocation && state.studentLocation.accuracy
    ? `${Math.round(state.studentLocation.accuracy)}m`
    : '';
  const accuracyWarning = state.studentLocation && state.studentLocation.accuracy > 50
    ? '<span class="text-amber-600 dark:text-amber-400 text-xs ml-1">(poor signal)</span>'
    : '';

  // Check for code in URL params
  const urlParams = getUrlParams();
  const prefillCode = urlParams.code || '';

  // Get saved info for pre-filling
  const savedInfo = state.savedStudentInfo;
  const prefillStudentId = savedInfo ? savedInfo.studentId : '';
  const prefillStudentName = savedInfo ? savedInfo.studentName : '';
  const prefillStudentEmail = savedInfo ? savedInfo.studentEmail : '';

  // QUICK CONFIRM MODE: Returning student with code from QR
  // Show simplified one-tap confirm screen (AC6.2)
  const showQuickConfirm = savedInfo && prefillCode && state.showSavedInfoBanner && !state.showFullForm;

  if (showQuickConfirm) {
    return `
      <div class="flex items-center justify-center min-h-screen py-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
          <div class="mb-6">
            <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Welcome back!</h2>
            <p class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mb-1">${escapeHtml(savedInfo.studentName)}</p>
            <p class="text-gray-500 dark:text-gray-400">Student ID: ${escapeHtml(savedInfo.studentId)}</p>
          </div>

          <div id="studentMessage"></div>

          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Attendance Code</p>
            <p class="text-3xl font-mono font-bold text-emerald-600 dark:text-emerald-400 tracking-widest">${escapeHtml(prefillCode)}</p>
          </div>

          <div class="mb-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">
              ${state.studentLocation
                ? `<span class="text-emerald-600 dark:text-emerald-400">üìç Location acquired</span>`
                : `<span class="text-yellow-600 dark:text-yellow-400">üìç Acquiring location...</span>`
              }
            </p>
          </div>

          <button onclick="quickConfirmAttendance()" id="submitBtn" class="w-full py-5 px-6 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-bold text-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
            ‚úì Confirm Attendance
          </button>

          <button onclick="showFullStudentForm()" class="mt-4 text-sm text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-400 underline">
            Edit my details
          </button>
        </div>
      </div>`;
  }

  // FULL FORM MODE: New students or editing details
  // Clear saved info button (only show if there's saved info but banner is dismissed)
  const clearSavedButton = savedInfo && !state.showSavedInfoBanner ? `
    <button onclick="clearStudentInfo(); render();" class="text-xs text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-400 underline">
      Clear saved info
    </button>
  ` : '';

  // Welcome banner for returning students (when not in quick confirm mode)
  // Simplified: just show a dismissible message, form is already pre-filled
  const welcomeBanner = state.showSavedInfoBanner && savedInfo && !prefillCode ? `
    <div class="mb-4 p-4 bg-emerald-50 dark:bg-emerald-900/30 rounded-lg border border-emerald-200 dark:border-emerald-700 flex items-center justify-between">
      <div>
        <p class="text-emerald-800 dark:text-emerald-200 font-semibold">Welcome back, ${escapeHtml(savedInfo.studentName)}!</p>
        <p class="text-sm text-emerald-600 dark:text-emerald-400">Your info is pre-filled. Just enter the code and submit.</p>
      </div>
      <button onclick="state.showSavedInfoBanner = false; render();" class="text-emerald-400 hover:text-emerald-600 dark:text-emerald-500 dark:hover:text-emerald-300 ml-4" title="Dismiss">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
  ` : '';

  return `
    <div class="flex items-center justify-center min-h-screen py-8">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-md">
        <button onclick="setMode(null)" class="mb-4 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium">‚Üê Back</button>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Mark Attendance</h2>
        <p class="text-gray-500 dark:text-gray-400 text-sm mb-6">Enter your details and the code shown by your instructor</p>
        ${welcomeBanner}
        <div id="studentMessage"></div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Student Number <span class="text-red-500">*</span></label>
            <input type="text" id="studentId" placeholder="e.g., 11223344" maxlength="20" autocomplete="off" value="${escapeHtml(prefillStudentId)}" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name <span class="text-red-500">*</span></label>
            <input type="text" id="studentName" placeholder="e.g., Nguyen Van A" maxlength="100" autocomplete="off" value="${escapeHtml(prefillStudentName)}" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email <span class="text-red-500">*</span></label>
            <input type="email" id="studentEmail" placeholder="e.g., student@st.neu.edu.vn" maxlength="100" autocomplete="off" value="${escapeHtml(prefillStudentEmail)}" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Attendance Code <span class="text-red-500">*</span></label>
            <input type="text" id="enteredCode" placeholder="XXXXXX" maxlength="6" autocomplete="off" value="${escapeHtml(prefillCode)}" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white text-center code-display text-3xl uppercase tracking-widest" oninput="this.value = this.value.toUpperCase()">
            ${prefillCode ? '<p class="text-xs text-emerald-600 dark:text-emerald-400 mt-1">Code auto-filled from QR scan</p>' : ''}
          </div>

          <!-- Auto-populated device info -->
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 space-y-3">
            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wide">Device Information (auto-detected)</p>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Device ID</label>
                <div class="px-3 py-2 bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded text-sm font-mono text-gray-700 dark:text-gray-200">${state.deviceId || 'Loading...'}</div>
              </div>
              <div>
                <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Accuracy</label>
                <div class="px-3 py-2 bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded text-sm text-gray-700 dark:text-gray-200">${accuracyDisplay ? '¬±' + accuracyDisplay : 'Pending...'}${accuracyWarning}</div>
              </div>
            </div>
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Your Location (Lat, Lng)</label>
              <div class="px-3 py-2 bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded text-sm font-mono ${state.studentLocation ? 'text-emerald-700 dark:text-emerald-400' : state.locationError ? 'text-red-600 dark:text-red-400' : 'text-yellow-600 dark:text-yellow-400'}">
                ${state.locationError ? state.locationError : (state.studentLocation ? locDisplay : locDisplay)}
              </div>
            </div>
            ${state.studentLocation ? '' : `<button onclick="acquireStudentLocation()" class="w-full py-2 px-3 bg-yellow-100 dark:bg-yellow-900/30 hover:bg-yellow-200 dark:hover:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300 rounded text-sm font-medium">Retry Location</button>`}
          </div>

          <button onclick="submitAttendance()" id="submitBtn" class="w-full py-4 px-6 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl font-semibold text-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Submit Attendance</button>
          <div class="flex justify-between items-center">
            <p class="text-xs text-gray-400 dark:text-gray-500">Location is optional but helps verify physical presence.</p>
            ${clearSavedButton}
          </div>
        </div>
      </div>
    </div>`;
}

function toggleFailedSelection(firebaseKey) {
  if (state.selectedFailedAttempts.has(firebaseKey)) {
    state.selectedFailedAttempts.delete(firebaseKey);
  } else {
    state.selectedFailedAttempts.add(firebaseKey);
  }
  render();
}

function toggleSelectAllFailed() {
  if (state.selectedFailedAttempts.size === state.failedAttempts.length) {
    state.selectedFailedAttempts.clear();
  } else {
    state.failedAttempts.forEach(f => state.selectedFailedAttempts.add(f.firebaseKey));
  }
  render();
}

async function bulkApproveSelected() {
  if (state.selectedFailedAttempts.size === 0) return;

  const count = state.selectedFailedAttempts.size;
  if (!confirm(`Approve ${count} selected student(s)?`)) return;

  const keys = Array.from(state.selectedFailedAttempts);
  for (const key of keys) {
    await approveStudent(key, false); // false = don't re-render for each
  }

  state.selectedFailedAttempts.clear();
  render();
}

function setMode(mode) {
  cleanupListeners();

  state.mode = mode;
  state.session = null;
  state.attendance = [];
  state.failedAttempts = [];
  state.studentLocation = null;
  state.locationError = null;
  state.isRecovering = false;
  state.pinVerified = false;
  state.showHistory = false;
  state.selectedFailedAttempts = new Set();
  state.isReopenedSession = false;

  const url = new URL(window.location);
  if (mode) { url.searchParams.set('mode', mode); } else { url.searchParams.delete('mode'); }
  url.searchParams.delete('code'); // Clear code param when changing mode
  window.history.pushState({}, '', url);

  render();
  if (!mode) setTimeout(generateModeQRCodes, 100);
  if (mode === 'student') {
    acquireStudentLocation();
    initDeviceId();
    // Load saved student info
    state.savedStudentInfo = loadStudentInfo();
    state.showSavedInfoBanner = !!state.savedStudentInfo;
    render();
  }
}

function cleanupListeners() {
  if (state.codeInterval) { clearInterval(state.codeInterval); state.codeInterval = null; }
  if (state.attendanceListener && state.session) {
    db.ref('attendance/' + state.session.id).off('value');
    state.attendanceListener = null;
  }
  if (state.failedListener && state.session) {
    db.ref('failed/' + state.session.id).off('value');
    state.failedListener = null;
  }
  if (state.sessionListener && state.session) {
    db.ref('sessions/' + state.session.id).off('value');
    state.sessionListener = null;
  }
}

async function loadSessionHistory() {
  try {
    // Load more sessions for "Show All" feature (AC8)
    const snapshot = await db.ref('sessions').orderByChild('createdAt').limitToLast(100).once('value');
    const sessions = [];
    snapshot.forEach(child => {
      const session = child.val();
      session.id = child.key; // Ensure ID is set
      sessions.push(session);
    });

    // Fetch real attendance counts for sessions that don't have stored counts
    // This fixes the "0" stats issue for sessions created before counts were stored
    for (const session of sessions) {
      if (session.attendanceCount === undefined || session.attendanceCount === null) {
        try {
          const attendanceSnapshot = await db.ref('attendance/' + session.id).once('value');
          const attendanceData = attendanceSnapshot.val() || {};
          const attendanceList = Object.values(attendanceData);
          session.attendanceCount = attendanceList.length;
          session.lateCount = attendanceList.filter(a => a.isLate || a.lateCheckIn).length;
        } catch (e) {
          console.warn('Could not fetch attendance for session:', session.id);
          session.attendanceCount = 0;
          session.lateCount = 0;
        }
      }
    }

    state.sessionHistory = sessions.reverse(); // Most recent first
    render();
  } catch (err) {
    console.error('Failed to load session history:', err);
    state.sessionHistory = [];
    render();
  }
}

async function tryRecoverSession() {
  const savedSessionId = loadSessionFromStorage();
  if (!savedSessionId) return;

  state.isRecovering = true;
  render();

  try {
    const activeSnapshot = await db.ref('activeSession').once('value');
    const activeSessionId = activeSnapshot.val();

    if (activeSessionId !== savedSessionId) {
      clearSessionStorage();
      state.isRecovering = false;
      render();
      return;
    }

    const sessionSnapshot = await db.ref('sessions/' + savedSessionId).once('value');
    const session = sessionSnapshot.val();

    if (!session) {
      clearSessionStorage();
      state.isRecovering = false;
      render();
      return;
    }

    state.session = session;
    state.currentCode = session.code;
    state.lateThreshold = session.lateThreshold || DEFAULT_LATE_THRESHOLD_MINUTES;
    state.isReopenedSession = session.isReopened || false;

    const elapsed = Math.floor((Date.now() - session.codeGeneratedAt) / 1000);
    state.timeLeft = Math.max(0, CODE_REFRESH_SECONDS - elapsed);

    setupCodeRotation();
    setupSessionListeners(savedSessionId);

    state.isRecovering = false;
    render();

  } catch (err) {
    console.error('Session recovery failed:', err);
    clearSessionStorage();
    state.isRecovering = false;
    render();
  }
}

async function reopenSession(sessionId) {
  if (!confirm('Reopen this session for late check-ins? Students checking in will be marked as late.')) return;

  state.isRecovering = true;
  state.showHistory = false;
  render();

  try {
    // Load the session
    const sessionSnapshot = await db.ref('sessions/' + sessionId).once('value');
    const session = sessionSnapshot.val();

    if (!session) {
      alert('Session not found');
      state.isRecovering = false;
      render();
      return;
    }

    // Get instructor location
    let location;
    try {
      location = await getLocation();
    } catch (err) {
      alert('Location access required to reopen session. Please enable location and try again.');
      state.isRecovering = false;
      render();
      return;
    }

    // Generate new code
    const newCode = generateCode();

    // Update session in Firebase
    await db.ref('sessions/' + sessionId).update({
      code: newCode,
      codeGeneratedAt: Date.now(),
      isReopened: true,
      reopenedAt: new Date().toISOString(),
      location: location, // Update to current location
      endedAt: null // Clear the ended timestamp
    });

    // Set as active session
    await db.ref('activeSession').set(sessionId);

    // Update local state
    state.session = {
      ...session,
      code: newCode,
      codeGeneratedAt: Date.now(),
      isReopened: true,
      location: location,
      endedAt: null
    };
    state.currentCode = newCode;
    state.timeLeft = CODE_REFRESH_SECONDS;
    state.lateThreshold = session.lateThreshold || DEFAULT_LATE_THRESHOLD_MINUTES;
    state.isReopenedSession = true;

    saveSessionToStorage(sessionId);
    setupCodeRotation();
    setupSessionListeners(sessionId);

    state.isRecovering = false;
    render();

  } catch (err) {
    console.error('Failed to reopen session:', err);
    alert('Error reopening session: ' + err.message);
    state.isRecovering = false;
    render();
  }
}

function setupCodeRotation() {
  if (state.codeInterval) clearInterval(state.codeInterval);

  state.codeInterval = setInterval(async () => {
    state.timeLeft--;

    // Play warning beep at countdown threshold
    if (state.timeLeft <= COUNTDOWN_WARNING_SECONDS && state.timeLeft > 0) {
      const now = Date.now();
      if (now - state.lastWarningTime >= 1000) { // Don't beep more than once per second
        playWarningBeep();
        state.lastWarningTime = now;
      }
    }

    if (state.timeLeft <= 0) {
      // Code rotation - need full re-render to update QR code
      const previousCode = state.currentCode;
      const newCode = generateCode();
      state.currentCode = newCode;
      state.timeLeft = CODE_REFRESH_SECONDS;
      state.session.previousCode = previousCode;
      state.session.code = newCode;
      state.session.codeGeneratedAt = Date.now();
      try {
        await db.ref('sessions/' + state.session.id).update({
          code: newCode,
          previousCode: previousCode,
          codeGeneratedAt: Date.now()
        });
      } catch (err) {
        console.error('Failed to update code:', err);
      }
      render(); // Full render only when code changes
    } else {
      // Just update the timer display without full re-render
      updateTimerDisplay();
    }
  }, 1000);
}

// Update only the countdown timer without re-rendering the whole page
function updateTimerDisplay() {
  const timerEl = document.getElementById('countdown-timer');
  if (timerEl) {
    timerEl.textContent = formatTime(state.timeLeft);
    // Add/remove warning class
    if (state.timeLeft <= COUNTDOWN_WARNING_SECONDS) {
      timerEl.classList.add('text-red-600', 'dark:text-red-400');
    } else {
      timerEl.classList.remove('text-red-600', 'dark:text-red-400');
    }
  }
}

function setupSessionListeners(sessionId) {
  state.attendanceListener = db.ref('attendance/' + sessionId).on('value', snapshot => {
    const data = snapshot.val();
    const prevCount = state.attendance.length;
    if (data) {
      state.attendance = Object.values(data)
        .map(a => ({
          ...a,
          isLate: isLateCheckIn(a.timestamp, state.session.createdAt, state.lateThreshold) || a.lateCheckIn
        }))
        .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      // Play sound for new check-ins (instructor side)
      if (state.attendance.length > prevCount && prevCount > 0) {
        playSuccessSound();
      }
    } else {
      state.attendance = [];
    }
    render();
  });

  state.failedListener = db.ref('failed/' + sessionId).on('value', snapshot => {
    const data = snapshot.val();
    if (data) {
      state.failedAttempts = Object.entries(data).map(([key, val]) => ({ ...val, firebaseKey: key }))
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    } else {
      state.failedAttempts = [];
    }
    // Clean up selections for items that no longer exist
    const validKeys = new Set(state.failedAttempts.map(f => f.firebaseKey));
    state.selectedFailedAttempts = new Set([...state.selectedFailedAttempts].filter(k => validKeys.has(k)));
    render();
  });

  state.sessionListener = db.ref('sessions/' + sessionId).on('value', snapshot => {
    const data = snapshot.val();
    if (data && state.session) {
      if (data.code !== state.session.code) {
        state.session.code = data.code;
        state.currentCode = data.code;
        state.session.codeGeneratedAt = data.codeGeneratedAt;
        const elapsed = Math.floor((Date.now() - data.codeGeneratedAt) / 1000);
        state.timeLeft = Math.max(0, CODE_REFRESH_SECONDS - elapsed);
        render();
      }
    }
  });
}

async function initDeviceId() {
  state.deviceId = await generateDeviceId();
  render();
}

// Safe QR code generation with fallback for when library fails to load
// Uses davidshimjs/qrcodejs API: new QRCode(element, { text, width, height })
function safeQRGenerate(container, url, options, onError) {
  if (!isQRCodeAvailable()) {
    console.warn('QRCode library not available. Displaying fallback.');
    if (container) {
      container.innerHTML = `<div class="qr-fallback"><p class="qr-fallback-text">QR code unavailable</p><p class="text-xs text-gray-400 mt-1">Use link below</p></div>`;
    }
    if (onError) onError(new Error('QRCode library not loaded'));
    return;
  }

  try {
    // Clear container before generating new QR
    if (container) {
      container.innerHTML = '';
    }

    const size = options?.width || 128;
    new QRCode(container, {
      text: url,
      width: size,
      height: size,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.M
    });
  } catch (err) {
    console.error('QR generation exception:', err);
    if (container) {
      container.innerHTML = `<div class="qr-fallback"><p class="qr-fallback-text">QR unavailable</p></div>`;
    }
    if (onError) onError(err);
  }
}

function generateModeQRCodes() {
  const baseUrl = getBaseUrl();
  const tc = document.getElementById('qr-teacher');
  const sc = document.getElementById('qr-student');

  safeQRGenerate(tc, `${baseUrl}?mode=teacher`, { width: 80 });
  safeQRGenerate(sc, `${baseUrl}?mode=student`, { width: 80 });
}

function generateSetupQRCodes() {
  const baseUrl = getBaseUrl();
  const sl = document.getElementById('qr-student-large');
  const tl = document.getElementById('qr-teacher-large');

  safeQRGenerate(sl, `${baseUrl}?mode=student`, { width: 150 });
  safeQRGenerate(tl, `${baseUrl}?mode=teacher`, { width: 150 });
}

function generateQRCodes() {
  const baseUrl = getBaseUrl();
  const sc = document.getElementById('qr-student-checkin');
  if (!sc) return;

  // Clear container first
  sc.innerHTML = '';

  // Include current code in QR for auto-fill
  const qrUrl = `${baseUrl}?mode=student&code=${state.currentCode}`;
  const currentCode = state.currentCode;

  safeQRGenerate(sc, qrUrl, { width: 180 });

  // After QR is generated, cache the data URL for future renders
  setTimeout(() => {
    const canvas = sc.querySelector('canvas');
    const img = sc.querySelector('img');
    let dataUrl = null;

    if (canvas) {
      dataUrl = canvas.toDataURL('image/png');
    } else if (img && img.src) {
      dataUrl = img.src;
    }

    if (dataUrl) {
      state.cachedQRCode = { code: currentCode, dataUrl };
    }
  }, 50); // Small delay to ensure QR is fully rendered
}

async function acquireStudentLocation() {
  state.locationError = null;
  state.studentLocation = null;
  render();
  try {
    state.studentLocation = await getLocation();
    state.locationError = null;
  }
  catch (err) {
    state.locationError = 'Enable location access and tap Retry';
    state.studentLocation = null;
  }
  render();
}

async function startSession() {
  const className = document.getElementById('className').value.trim();
  const radius = parseInt(document.getElementById('radius').value);
  if (!className) { alert('Please enter a class name'); return; }
  const btn = document.getElementById('startBtn');
  btn.disabled = true; btn.textContent = 'Getting location...';
  try {
    const location = await getLocation();
    state.teacherLocation = location;
    const sessionId = Date.now().toString(36), code = generateCode();
    const session = {
      id: sessionId,
      className,
      location,
      radius,
      code,
      codeGeneratedAt: Date.now(),
      createdAt: new Date().toISOString(),
      lateThreshold: state.lateThreshold
    };
    await db.ref('sessions/' + sessionId).set(session);
    await db.ref('activeSession').set(sessionId);
    state.session = session;
    state.currentCode = code;
    state.timeLeft = CODE_REFRESH_SECONDS;
    state.isReopenedSession = false;

    saveSessionToStorage(sessionId);
    setupCodeRotation();
    setupSessionListeners(sessionId);

    render();
  } catch (err) {
    alert('Error: ' + err.message + '\n\nPlease enable location access.');
    btn.disabled = false; btn.textContent = 'Start Session';
  }
}

async function endSession() {
  const action = state.isReopenedSession ? 'close' : 'end';
  if (!confirm(`${state.isReopenedSession ? 'Close' : 'End'} this session?`)) return;

  // Save session summary before ending
  if (state.session) {
    const lateCount = state.attendance.filter(a => a.isLate).length;
    try {
      await db.ref('sessions/' + state.session.id).update({
        endedAt: new Date().toISOString(),
        attendanceCount: state.attendance.length,
        lateCount: lateCount,
        isReopened: false // Clear reopened flag when closing
      });
    } catch (err) {
      console.error('Failed to save session summary:', err);
    }
  }

  cleanupListeners();
  clearSessionStorage();

  try {
    await db.ref('activeSession').remove();
  } catch (err) {
    console.error('Failed to clear active session:', err);
  }

  state.session = null;
  state.currentCode = '';
  state.selectedFailedAttempts = new Set();
  state.isReopenedSession = false;
  render();
  setTimeout(generateSetupQRCodes, 100);
}

async function approveStudent(firebaseKey, shouldRender = true) {
  if (!state.session) return;

  try {
    const snapshot = await db.ref('failed/' + state.session.id + '/' + firebaseKey).once('value');
    const failedData = snapshot.val();

    if (!failedData) {
      if (shouldRender) alert('Record not found');
      return;
    }

    const existingSnapshot = await db.ref('attendance/' + state.session.id)
      .orderByChild('studentId')
      .equalTo(failedData.studentId)
      .once('value');

    if (existingSnapshot.exists()) {
      if (shouldRender) alert('This student is already in the attendance list.');
      await db.ref('failed/' + state.session.id + '/' + firebaseKey).remove();
      return;
    }

    const isLate = isLateCheckIn(new Date().toISOString(), state.session.createdAt, state.lateThreshold);

    await db.ref('attendance/' + state.session.id).push({
      studentId: failedData.studentId,
      studentName: failedData.studentName,
      email: failedData.email,
      deviceId: failedData.deviceId,
      location: failedData.location,
      distance: failedData.distance,
      timestamp: new Date().toISOString(),
      manuallyApproved: true,
      originalFailReason: failedData.reason,
      isLate: isLate
    });

    await db.ref('failed/' + state.session.id + '/' + firebaseKey).remove();

    // Remove from selection
    state.selectedFailedAttempts.delete(firebaseKey);

  } catch (err) {
    if (shouldRender) alert('Error approving student: ' + err.message);
  }
}

// Debounce for submit button
let lastSubmitTime = 0;
const SUBMIT_DEBOUNCE_MS = 2000;

async function submitAttendance() {
  const now = Date.now();
  if (now - lastSubmitTime < SUBMIT_DEBOUNCE_MS) {
    return;
  }
  lastSubmitTime = now;

  const studentId = document.getElementById('studentId').value.trim();
  const studentName = document.getElementById('studentName').value.trim();
  const studentEmail = document.getElementById('studentEmail').value.trim();
  const enteredCode = document.getElementById('enteredCode').value.trim().toUpperCase();
  const msgDiv = document.getElementById('studentMessage');

  // BUG FIX: Save student info FIRST (before any validation)
  // This ensures info is saved on ANY submission attempt, not just success
  // Journey Reference: student-check-in.md AC6.1
  if (studentId && studentName && studentEmail) {
    saveStudentInfo({ studentId, studentName, studentEmail });
    state.savedStudentInfo = { studentId, studentName, studentEmail };
  }

  if (!studentId || !studentName || !studentEmail || !enteredCode) {
    msgDiv.innerHTML = '<div class="mb-4 p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg">Please fill in all fields</div>';
    return;
  }
  if (enteredCode.length !== 6) {
    msgDiv.innerHTML = '<div class="mb-4 p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg">Code must be 6 characters</div>';
    return;
  }
  if (!studentEmail.includes('@')) {
    msgDiv.innerHTML = '<div class="mb-4 p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg">Please enter a valid email address</div>';
    return;
  }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = 'Verifying...';

  try {
    const activeSnapshot = await db.ref('activeSession').once('value');
    const activeSessionId = activeSnapshot.val();
    if (!activeSessionId) throw new Error('No active session. Ask your instructor to start one.');

    const sessionSnapshot = await db.ref('sessions/' + activeSessionId).once('value');
    const session = sessionSnapshot.val();
    if (!session) throw new Error('Session has ended. Please ask your instructor to start a new session.');

    // Calculate distance only if location is available
    const hasLocation = state.studentLocation && state.studentLocation.lat && state.studentLocation.lng;
    const distance = hasLocation
      ? getDistance(state.studentLocation.lat, state.studentLocation.lng, session.location.lat, session.location.lng)
      : null;

    const baseRecord = {
      studentId,
      studentName,
      email: studentEmail,
      deviceId: state.deviceId,
      location: hasLocation ? {
        lat: state.studentLocation.lat,
        lng: state.studentLocation.lng,
        accuracy: state.studentLocation.accuracy
      } : null,
      distance: hasLocation ? Math.round(distance) : null,
      allowedRadius: session.radius,
      timestamp: new Date().toISOString(),
      noGps: !hasLocation
    };

    // Code validation with support for recently expired codes
    const codeAge = Date.now() - session.codeGeneratedAt;
    const isCurrentCode = enteredCode === session.code;
    const isPreviousCode = session.previousCode && enteredCode === session.previousCode.toUpperCase();
    
    // Accept previous code if it expired within RECENTLY_EXPIRED_WINDOW seconds ago
    // The previous code was valid until codeGeneratedAt, so we check if that was recent enough
    const previousCodeStillAcceptable = isPreviousCode && (codeAge <= RECENTLY_EXPIRED_WINDOW * 1000);
    
    if (!isCurrentCode && !previousCodeStillAcceptable) {
      // Check if they entered the previous code but it's too old
      if (isPreviousCode) {
        await db.ref('failed/' + activeSessionId).push({ ...baseRecord, reason: 'Code expired (too old)' });
        throw new Error('That code has expired. Please use the current code on screen.');
      }
      await db.ref('failed/' + activeSessionId).push({ ...baseRecord, reason: 'Invalid code' });
      throw new Error('Invalid code. Check the code on screen. Your attempt has been logged.');
    }

    // Check if current code is expired (beyond grace period)
    if (isCurrentCode && codeAge > (CODE_REFRESH_SECONDS + CODE_GRACE_PERIOD) * 1000) {
      await db.ref('failed/' + activeSessionId).push({ ...baseRecord, reason: 'Expired code' });
      throw new Error('Code expired. Enter the new code. Your attempt has been logged.');
    }

    // Only check distance if location is available
    if (hasLocation && distance > session.radius) {
      await db.ref('failed/' + activeSessionId).push({ ...baseRecord, reason: `Too far: ${Math.round(distance)}m` });
      throw new Error(`You're ${Math.round(distance)}m away (limit: ${session.radius}m). Your attempt has been logged for instructor review.`);
    }

    const existingSnapshot = await db.ref('attendance/' + activeSessionId).orderByChild('studentId').equalTo(studentId).once('value');
    if (existingSnapshot.exists()) throw new Error('This Student Number has already checked in.');

    const deviceSnapshot = await db.ref('attendance/' + activeSessionId).orderByChild('deviceId').equalTo(state.deviceId).once('value');
    if (deviceSnapshot.exists()) throw new Error('This device has already been used to check in.');

    // Calculate if late (either by time threshold or if session was reopened)
    const lateThreshold = session.lateThreshold || DEFAULT_LATE_THRESHOLD_MINUTES;
    const isLate = isLateCheckIn(baseRecord.timestamp, session.createdAt, lateThreshold);
    const lateCheckIn = session.isReopened || false; // Mark as late if session was reopened

    await db.ref('attendance/' + activeSessionId).push({
      ...baseRecord,
      manuallyApproved: false,
      isLate: isLate || lateCheckIn,
      lateCheckIn: lateCheckIn, // Additional flag for reopened session check-ins
      locationProvided: hasLocation // Track whether location was provided for instructor review
    });

    // Student info was already saved at the beginning of this function
    // Just update the banner state
    state.showSavedInfoBanner = false;

    // Success feedback
    playSuccessSound();
    triggerVibration([200, 100, 200]);

    const lateMessage = (isLate || lateCheckIn)
      ? '<p class="text-xs text-orange-600 dark:text-orange-400 mt-2">Note: You have been marked as late.</p>'
      : '';

    msgDiv.innerHTML = `<div class="mb-4 p-4 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-lg"><p class="font-semibold text-lg">Success!</p><p class="text-sm mt-1">Attendance recorded for <strong>${escapeHtml(session.className)}</strong></p>${lateMessage}<p class="text-xs mt-2">You can close this page now.</p><p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Your info has been saved for next time.</p></div>`;
    document.getElementById('enteredCode').value = '';
    btn.textContent = 'Submitted';
  } catch (err) {
    msgDiv.innerHTML = `<div class="mb-4 p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg">${escapeHtml(err.message)}</div>`;
    btn.textContent = 'Submit Attendance'; btn.disabled = false;
  }
}

function exportCSV() {
  if (!state.attendance.length || !state.session) return;
  const headers = ['#', 'Student Number', 'Name', 'Email', 'Device ID', 'Latitude', 'Longitude', 'Distance (m)', 'Location Provided', 'Status', 'Manually Approved', 'Late Check-in', 'Timestamp'];
  const rows = state.attendance.map((a, i) => [
    i + 1,
    a.studentId,
    a.studentName,
    a.email || '',
    a.deviceId || '',
    a.location ? a.location.lat : '',
    a.location ? a.location.lng : '',
    a.distance,
    a.locationProvided !== false && a.location ? 'Yes' : 'No',
    a.isLate ? 'Late' : 'On Time',
    a.manuallyApproved ? 'Yes' : 'No',
    a.lateCheckIn ? 'Yes' : 'No',
    a.timestamp
  ]);
  const BOM = '\uFEFF';
  const csv = BOM + [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `attendance_${state.session.className.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

function exportFailedCSV() {
  if (!state.failedAttempts.length || !state.session) return;
  const headers = ['#', 'Student Number', 'Name', 'Email', 'Device ID', 'Latitude', 'Longitude', 'Distance (m)', 'Allowed Radius (m)', 'Failure Reason', 'Timestamp'];
  const rows = state.failedAttempts.map((f, i) => [
    i + 1,
    f.studentId,
    f.studentName,
    f.email || '',
    f.deviceId || '',
    f.location ? f.location.lat : '',
    f.location ? f.location.lng : '',
    f.distance,
    f.allowedRadius,
    f.reason,
    f.timestamp
  ]);
  const BOM = '\uFEFF';
  const csv = BOM + [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `failed_attempts_${state.session.className.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}


// ============================================
// AC8: Session History Management Functions
// ============================================

// View session details (AC8)
async function viewSessionDetails(sessionId) {
  try {
    // Load session info
    const sessionSnapshot = await db.ref('sessions/' + sessionId).once('value');
    const session = sessionSnapshot.val();
    if (!session) {
      alert('Session not found');
      return;
    }
    session.id = sessionId;
    state.selectedHistorySession = session;

    // Load attendance for this session
    const attendanceSnapshot = await db.ref('attendance/' + sessionId).once('value');
    const attendanceData = attendanceSnapshot.val() || {};
    state.selectedSessionAttendance = Object.entries(attendanceData).map(([key, val]) => ({
      ...val,
      firebaseKey: key,
      isLate: isLateCheckIn(val.timestamp, session.createdAt, session.lateThreshold || DEFAULT_LATE_THRESHOLD_MINUTES) || val.lateCheckIn
    })).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    render();
  } catch (err) {
    console.error('Failed to load session details:', err);
    alert('Error loading session: ' + err.message);
  }
}

// Render session detail view (AC8)

// Reopen session from detail view (clears selected session first)
async function reopenSessionFromDetail(sessionId) {
  state.selectedHistorySession = null;
  state.selectedSessionAttendance = [];
  await reopenSession(sessionId);
}

function renderSessionDetailView() {
  const session = state.selectedHistorySession;
  const attendance = state.selectedSessionAttendance;
  const lateCount = attendance.filter(a => a.isLate).length;
  const onTimeCount = attendance.length - lateCount;

  // Calculate if session can be reopened (ended and within 7 days)
  const isEnded = !!session.endedAt;
  const daysSinceCreated = Math.floor((Date.now() - new Date(session.createdAt).getTime()) / (1000 * 60 * 60 * 24));
  const canReopen = isEnded && daysSinceCreated <= 7;

  return `
    <div class="pt-8">
      <button onclick="state.selectedHistorySession = null; state.selectedSessionAttendance = []; render();" class="mb-4 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium no-print">‚Üê Back to History</button>
      
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 mb-6">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">${escapeHtml(session.className)}</h2>
            <p class="text-gray-500 dark:text-gray-400">${new Date(session.createdAt).toLocaleDateString()} ${new Date(session.createdAt).toLocaleTimeString()}</p>
            ${session.endedAt ? '<p class="text-sm text-gray-400 dark:text-gray-500">Ended: ' + new Date(session.endedAt).toLocaleTimeString() + '</p>' : '<p class="text-sm text-green-500">Currently Active</p>'}
          </div>
          <div class="flex gap-2">
            ${canReopen ? '<button onclick="reopenSessionFromDetail(\'' + session.id + '\')" class="px-4 py-2 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded-lg hover:bg-orange-200 dark:hover:bg-orange-900/50 font-medium text-sm">Reopen for Late</button>' : ''}
            <button onclick="openAddStudentModal()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium text-sm">+ Add Student</button>
            <button onclick="exportHistoryCSV()" class="px-4 py-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900/50 font-medium text-sm">Export CSV</button>
          </div>
        </div>
        
        <!-- Stats -->
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-emerald-700 dark:text-emerald-400">${onTimeCount}</p>
            <p class="text-sm text-emerald-600 dark:text-emerald-500">On Time</p>
          </div>
          <div class="bg-orange-50 dark:bg-orange-900/30 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-orange-700 dark:text-orange-400">${lateCount}</p>
            <p class="text-sm text-orange-600 dark:text-orange-500">Late</p>
          </div>
          <div class="bg-indigo-50 dark:bg-indigo-900/30 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-indigo-700 dark:text-indigo-400">${attendance.length}</p>
            <p class="text-sm text-indigo-600 dark:text-indigo-500">Total</p>
          </div>
        </div>
      </div>
      
      <!-- Attendance List with Edit Options (AC8 & AC9) -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Attendance List</h3>
        ${attendance.length === 0 
          ? '<p class="text-gray-400 dark:text-gray-500 text-center py-6">No attendance records</p>'
          : `
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="sticky top-0 bg-white dark:bg-gray-800">
                  <tr class="border-b dark:border-gray-700">
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">#</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Student ID</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Name</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Email</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Time</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Device ID</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Status</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${attendance.map((a, i) => `
                    <tr class="border-b border-gray-100 dark:border-gray-700">
                      <td class="py-2 text-gray-400 dark:text-gray-500">${i + 1}</td>
                      <td class="py-2 font-mono text-gray-800 dark:text-gray-200">${escapeHtml(a.studentId)}</td>
                      <td class="py-2 text-gray-800 dark:text-gray-200">
                        ${escapeHtml(a.studentName)}
                        ${a.note ? '<span class="ml-1 text-xs text-gray-400" title="' + escapeHtml(a.note) + '">üìù</span>' : ''}
                      </td>
                      <td class="py-2 text-gray-500 dark:text-gray-400 text-xs">${escapeHtml(a.email || '')}</td>
                      <td class="py-2 text-gray-500 dark:text-gray-400">${new Date(a.timestamp).toLocaleTimeString()}</td>
                      <td class="py-2 text-gray-400 dark:text-gray-500 text-xs font-mono">${escapeHtml(a.deviceId || 'N/A')}</td>
                      <td class="py-2">
                        ${a.isLate
                          ? '<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded text-xs font-medium">Late</span>'
                          : '<span class="px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded text-xs font-medium">On Time</span>'
                        }
                        ${a.manuallyApproved || a.manualEntry ? '<span class="ml-1 px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded text-xs">Manual</span>' : ''}
                        ${a.lateCheckIn ? '<span class="ml-1 px-2 py-1 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400 rounded text-xs">Rejoined</span>' : ''}
                      </td>
                      <td class="py-2">
                        <div class="flex gap-1">
                          <button onclick="openEditStudentModal('${a.firebaseKey}')" class="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded hover:bg-gray-200 dark:hover:bg-gray-600" title="Edit">Edit</button>
                          <button onclick="openAddNoteModal('${a.firebaseKey}')" class="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded hover:bg-gray-200 dark:hover:bg-gray-600" title="Add Note">Note</button>
                          <button onclick="removeAttendanceEntry('${a.firebaseKey}')" class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded hover:bg-red-200 dark:hover:bg-red-900/50" title="Remove">X</button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `
        }
      </div>
    </div>`;
}

// Export CSV from history (AC8)
function exportHistoryCSV() {
  if (!state.selectedHistorySession || !state.selectedSessionAttendance.length) return;
  const session = state.selectedHistorySession;
  const attendance = state.selectedSessionAttendance;
  
  const headers = ['#', 'Student Number', 'Name', 'Email', 'Device ID', 'Latitude', 'Longitude', 'Distance (m)', 'Status', 'Manually Approved', 'Late Check-in', 'Note', 'Timestamp'];
  const rows = attendance.map((a, i) => [
    i + 1,
    a.studentId,
    a.studentName,
    a.email || '',
    a.deviceId || '',
    a.location ? a.location.lat : '',
    a.location ? a.location.lng : '',
    a.distance || '',
    a.isLate ? 'Late' : 'On Time',
    a.manuallyApproved || a.manualEntry ? 'Yes' : 'No',
    a.lateCheckIn ? 'Yes' : 'No',
    a.note || '',
    a.timestamp
  ]);
  const BOM = '\uFEFF';
  const csv = BOM + [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `attendance_${session.className.replace(/[^a-z0-9]/gi, '_')}_${new Date(session.createdAt).toISOString().split('T')[0]}.csv`;
  a.click();
}

// ============================================
// AC9: Edit Attendance Records Functions
// ============================================

// Modal functions
function openAddStudentModal() {
  state.showAddStudentModal = true;
  renderModals();
}

function closeAddStudentModal() {
  state.showAddStudentModal = false;
  renderModals();
}

function openEditStudentModal(firebaseKey) {
  const student = state.selectedSessionAttendance.find(a => a.firebaseKey === firebaseKey);
  if (student) {
    state.editingStudent = { ...student };
    state.showEditStudentModal = true;
    renderModals();
  }
}

function closeEditStudentModal() {
  state.showEditStudentModal = false;
  state.editingStudent = null;
  renderModals();
}

function openAddNoteModal(firebaseKey) {
  const student = state.selectedSessionAttendance.find(a => a.firebaseKey === firebaseKey);
  if (student) {
    state.noteTargetStudent = { ...student };
    state.showAddNoteModal = true;
    renderModals();
  }
}

function closeAddNoteModal() {
  state.showAddNoteModal = false;
  state.noteTargetStudent = null;
  renderModals();
}

// Add student manually (AC9)
async function submitAddStudent() {
  const studentId = document.getElementById('addStudentId').value.trim();
  const studentName = document.getElementById('addStudentName').value.trim();
  const studentEmail = document.getElementById('addStudentEmail').value.trim();
  const note = document.getElementById('addStudentNote').value.trim();

  if (!studentId || !studentName || !studentEmail) {
    alert('Please fill in all required fields');
    return;
  }
  if (!studentEmail.includes('@')) {
    alert('Please enter a valid email address');
    return;
  }

  const sessionId = state.selectedHistorySession.id;
  
  try {
    // Add to attendance
    const newEntry = {
      studentId,
      studentName,
      email: studentEmail,
      deviceId: 'MANUAL',
      timestamp: new Date().toISOString(),
      manualEntry: true,
      note: note || 'Manual entry by instructor',
      location: null,
      isLate: false
    };
    
    await db.ref('attendance/' + sessionId).push(newEntry);
    
    // Log audit trail
    await logAuditTrail(sessionId, 'ADD_STUDENT', {
      studentId,
      studentName,
      reason: note || 'Manual entry'
    });
    
    closeAddStudentModal();
    
    // Refresh the view
    await viewSessionDetails(sessionId);
  } catch (err) {
    alert('Error adding student: ' + err.message);
  }
}

// Edit student details (AC9)
async function submitEditStudent() {
  const studentId = document.getElementById('editStudentId').value.trim();
  const studentName = document.getElementById('editStudentName').value.trim();
  const studentEmail = document.getElementById('editStudentEmail').value.trim();

  if (!studentId || !studentName || !studentEmail) {
    alert('Please fill in all required fields');
    return;
  }

  const sessionId = state.selectedHistorySession.id;
  const firebaseKey = state.editingStudent.firebaseKey;
  const oldData = state.editingStudent;
  
  try {
    // Update in Firebase
    await db.ref('attendance/' + sessionId + '/' + firebaseKey).update({
      studentId,
      studentName,
      email: studentEmail,
      editedAt: new Date().toISOString()
    });
    
    // Log audit trail
    await logAuditTrail(sessionId, 'EDIT_STUDENT', {
      firebaseKey,
      oldData: { studentId: oldData.studentId, studentName: oldData.studentName, email: oldData.email },
      newData: { studentId, studentName, email: studentEmail }
    });
    
    closeEditStudentModal();
    
    // Refresh the view
    await viewSessionDetails(sessionId);
  } catch (err) {
    alert('Error updating student: ' + err.message);
  }
}

// Add note to attendance record (AC9)
async function submitAddNote() {
  const note = document.getElementById('studentNote').value.trim();
  const sessionId = state.selectedHistorySession.id;
  const firebaseKey = state.noteTargetStudent.firebaseKey;
  
  try {
    await db.ref('attendance/' + sessionId + '/' + firebaseKey).update({
      note: note,
      noteAddedAt: new Date().toISOString()
    });
    
    // Log audit trail
    await logAuditTrail(sessionId, 'ADD_NOTE', {
      firebaseKey,
      studentId: state.noteTargetStudent.studentId,
      note: note
    });
    
    closeAddNoteModal();
    
    // Refresh the view
    await viewSessionDetails(sessionId);
  } catch (err) {
    alert('Error adding note: ' + err.message);
  }
}

// Remove attendance entry (AC9)
async function removeAttendanceEntry(firebaseKey) {
  const student = state.selectedSessionAttendance.find(a => a.firebaseKey === firebaseKey);
  if (!student) return;
  
  const reason = prompt(`Remove ${student.studentName} from attendance?\n\nEnter reason (required):`);
  if (!reason) return;
  
  const sessionId = state.selectedHistorySession.id;
  
  try {
    // Remove from attendance
    await db.ref('attendance/' + sessionId + '/' + firebaseKey).remove();
    
    // Log audit trail
    await logAuditTrail(sessionId, 'REMOVE_STUDENT', {
      firebaseKey,
      studentId: student.studentId,
      studentName: student.studentName,
      reason: reason
    });
    
    // Refresh the view
    await viewSessionDetails(sessionId);
  } catch (err) {
    alert('Error removing student: ' + err.message);
  }
}

// Audit trail logging (AC9)
async function logAuditTrail(sessionId, action, details) {
  try {
    await db.ref('audit/' + sessionId).push({
      action,
      details,
      timestamp: new Date().toISOString(),
      performedBy: 'instructor'
    });
  } catch (err) {
    console.error('Failed to log audit trail:', err);
  }
}

// Render modals
function renderModals() {
  const container = document.getElementById('modalContainer');
  if (!container) return;

  let modalHtml = '';

  // Add Student Modal (AC9)
  if (state.showAddStudentModal && state.selectedHistorySession) {
    modalHtml += `
      <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onclick="closeAddStudentModal()">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Add Student Manually</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Add a student who couldn't check in via QR code.</p>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Student ID *</label>
              <input type="text" id="addStudentId" maxlength="20" placeholder="e.g., 11223344" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name *</label>
              <input type="text" id="addStudentName" maxlength="100" placeholder="e.g., Nguyen Van A" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email *</label>
              <input type="email" id="addStudentEmail" maxlength="100" placeholder="e.g., student@st.neu.edu.vn" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Note (optional)</label>
              <input type="text" id="addStudentNote" maxlength="200" placeholder="e.g., Approved by instructor" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="closeAddStudentModal()" class="flex-1 py-2 px-4 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium">Cancel</button>
            <button onclick="submitAddStudent()" class="flex-1 py-2 px-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium">Add Student</button>
          </div>
        </div>
      </div>`;
  }

  // Edit Student Modal (AC9)
  if (state.showEditStudentModal && state.editingStudent) {
    const student = state.editingStudent;
    modalHtml += `
      <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onclick="closeEditStudentModal()">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Edit Student Details</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Student ID *</label>
              <input type="text" id="editStudentId" maxlength="20" value="${escapeHtml(student.studentId || '')}" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name *</label>
              <input type="text" id="editStudentName" maxlength="100" value="${escapeHtml(student.studentName || '')}" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email *</label>
              <input type="email" id="editStudentEmail" maxlength="100" value="${escapeHtml(student.email || '')}" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
            </div>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="closeEditStudentModal()" class="flex-1 py-2 px-4 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium">Cancel</button>
            <button onclick="submitEditStudent()" class="flex-1 py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium">Save Changes</button>
          </div>
        </div>
      </div>`;
  }

  // Add Note Modal (AC9)
  if (state.showAddNoteModal && state.noteTargetStudent) {
    const student = state.noteTargetStudent;
    modalHtml += `
      <div class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onclick="closeAddNoteModal()">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4" onclick="event.stopPropagation()">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Add Note</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Add a note for ${escapeHtml(student.studentName)}</p>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Note</label>
            <textarea id="studentNote" rows="3" maxlength="500" placeholder="e.g., Approved by instructor, Technical issue during check-in" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">${escapeHtml(student.note || '')}</textarea>
          </div>
          ${student.note ? '<p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Current note will be replaced.</p>' : ''}
          <div class="flex gap-3 mt-6">
            <button onclick="closeAddNoteModal()" class="flex-1 py-2 px-4 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 font-medium">Cancel</button>
            <button onclick="submitAddNote()" class="flex-1 py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium">Save Note</button>
          </div>
        </div>
      </div>`;
  }

  container.innerHTML = modalHtml;
}

// ============================================
// Student Attendance Lookup (P4-03)
// ============================================

function renderLookupView() {
  const savedInfo = loadStudentInfo();
  const prefillStudentId = savedInfo ? savedInfo.studentId : '';
  
  return `
    <div class="flex items-center justify-center min-h-screen py-8">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 w-full max-w-2xl">
        <button onclick="setMode(null)" class="mb-4 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium">‚Üê Back</button>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">My Attendance History</h2>
        <p class="text-gray-500 dark:text-gray-400 text-sm mb-6">Enter your student ID to view all your attendance records</p>
        
        <div class="flex gap-3 mb-6">
          <input type="text" id="lookupStudentId" placeholder="Enter Student ID (e.g., 11223344)" maxlength="20" 
            value="${state.lookupStudentId || escapeHtml(prefillStudentId)}"
            class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white"
            onkeypress="if(event.key === 'Enter') searchAttendance()">
          <button onclick="searchAttendance()" id="searchBtn" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-colors disabled:opacity-50">
            ${state.lookupLoading ? 'Searching...' : 'Search'}
          </button>
        </div>
        
        ${state.lookupError ? '<div class="mb-4 p-3 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg">' + escapeHtml(state.lookupError) + '</div>' : ''}
        
        ${state.lookupResults.length === 0 && !state.lookupLoading && state.lookupStudentId ? 
          '<div class="text-center py-8"><p class="text-gray-400 dark:text-gray-500">No attendance records found for this student ID.</p></div>' 
          : ''}
        
        ${state.lookupResults.length > 0 ? renderLookupResults() : ''}
      </div>
    </div>`;
}

function renderLookupResults() {
  const totalRecords = state.lookupResults.length;
  const onTimeCount = state.lookupResults.filter(r => !r.isLate).length;
  const lateCount = totalRecords - onTimeCount;
  
  return `
    <div class="mb-4 grid grid-cols-3 gap-4">
      <div class="bg-indigo-50 dark:bg-indigo-900/30 rounded-lg p-3 text-center">
        <p class="text-2xl font-bold text-indigo-700 dark:text-indigo-400">${totalRecords}</p>
        <p class="text-xs text-indigo-600 dark:text-indigo-500">Total</p>
      </div>
      <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-lg p-3 text-center">
        <p class="text-2xl font-bold text-emerald-700 dark:text-emerald-400">${onTimeCount}</p>
        <p class="text-xs text-emerald-600 dark:text-emerald-500">On Time</p>
      </div>
      <div class="bg-orange-50 dark:bg-orange-900/30 rounded-lg p-3 text-center">
        <p class="text-2xl font-bold text-orange-700 dark:text-orange-400">${lateCount}</p>
        <p class="text-xs text-orange-600 dark:text-orange-500">Late</p>
      </div>
    </div>
    
    <div class="overflow-x-auto max-h-96 overflow-y-auto">
      <table class="w-full text-sm">
        <thead class="sticky top-0 bg-white dark:bg-gray-800">
          <tr class="border-b dark:border-gray-700">
            <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Course</th>
            <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Date</th>
            <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Time</th>
            <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium">Status</th>
          </tr>
        </thead>
        <tbody>
          ${state.lookupResults.map((r, i) => `
            <tr class="border-b border-gray-100 dark:border-gray-700">
              <td class="py-2 text-gray-800 dark:text-gray-200 font-medium">${escapeHtml(r.className)}</td>
              <td class="py-2 text-gray-500 dark:text-gray-400">${new Date(r.timestamp).toLocaleDateString()}</td>
              <td class="py-2 text-gray-500 dark:text-gray-400">${new Date(r.timestamp).toLocaleTimeString()}</td>
              <td class="py-2">
                ${r.isLate
                  ? '<span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-400 rounded text-xs font-medium">Late</span>'
                  : '<span class="px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded text-xs font-medium">On Time</span>'
                }
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>`;
}

async function searchAttendance() {
  const studentIdInput = document.getElementById('lookupStudentId');
  const studentId = studentIdInput ? studentIdInput.value.trim() : '';
  
  if (!studentId) {
    state.lookupError = 'Please enter a student ID';
    state.lookupResults = [];
    render();
    return;
  }
  
  state.lookupStudentId = studentId;
  state.lookupLoading = true;
  state.lookupError = null;
  state.lookupResults = [];
  render();
  
  try {
    // Query all sessions first
    const sessionsSnapshot = await db.ref('sessions').once('value');
    const sessions = sessionsSnapshot.val() || {};
    
    const results = [];
    
    // For each session, check attendance for this student
    for (const [sessionId, session] of Object.entries(sessions)) {
      const attendanceSnapshot = await db.ref('attendance/' + sessionId)
        .orderByChild('studentId')
        .equalTo(studentId)
        .once('value');
      
      const attendanceData = attendanceSnapshot.val();
      if (attendanceData) {
        for (const [key, record] of Object.entries(attendanceData)) {
          results.push({
            sessionId,
            className: session.className || 'Unknown Class',
            timestamp: record.timestamp,
            isLate: record.isLate || record.lateCheckIn || false,
            sessionCreatedAt: session.createdAt
          });
        }
      }
    }
    
    // Sort by timestamp (most recent first)
    results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    state.lookupResults = results;
    state.lookupLoading = false;
    render();
    
  } catch (err) {
    console.error('Attendance lookup failed:', err);
    state.lookupError = 'Error searching attendance. Please try again.';
    state.lookupLoading = false;
    render();
  }
}


// ============================================
// Analytics Dashboard Functions
// ============================================

async function loadAnalyticsData() {
  state.analyticsLoading = true;
  render();

  try {
    // Load all sessions
    const sessionsSnapshot = await db.ref('sessions').once('value');
    const sessions = [];
    sessionsSnapshot.forEach(child => {
      const session = child.val();
      session.id = child.key;
      sessions.push(session);
    });

    // Load attendance for all sessions
    const attendanceBySession = {};
    const studentAttendance = {}; // { studentId: { name, sessions: [...] } }

    for (const session of sessions) {
      const attendanceSnapshot = await db.ref('attendance/' + session.id).once('value');
      const attendanceData = attendanceSnapshot.val() || {};
      const attendanceList = Object.values(attendanceData);
      attendanceBySession[session.id] = attendanceList;

      // Track per-student attendance
      for (const record of attendanceList) {
        if (!studentAttendance[record.studentId]) {
          studentAttendance[record.studentId] = {
            name: record.studentName,
            email: record.email,
            sessions: []
          };
        }
        studentAttendance[record.studentId].sessions.push({
          sessionId: session.id,
          className: session.className,
          timestamp: record.timestamp,
          isLate: record.isLate || record.lateCheckIn
        });
      }
    }

    // Calculate statistics
    const totalSessions = sessions.length;
    const uniqueStudents = Object.keys(studentAttendance).length;

    // Calculate average attendance rate (per session)
    let totalAttendanceRate = 0;
    const sessionStats = sessions.map(s => {
      const attendance = attendanceBySession[s.id] || [];
      // Use unique students or attendance count, whichever makes sense
      const rate = uniqueStudents > 0 ? (attendance.length / uniqueStudents) * 100 : 0;
      totalAttendanceRate += rate;
      return {
        id: s.id,
        className: s.className,
        createdAt: s.createdAt,
        attendanceCount: attendance.length,
        rate: Math.min(rate, 100) // Cap at 100%
      };
    }).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

    const avgAttendanceRate = totalSessions > 0 ? totalAttendanceRate / totalSessions : 0;

    // Calculate per-student statistics
    const studentStats = Object.entries(studentAttendance).map(([studentId, data]) => {
      const sessionsAttended = data.sessions.length;
      const rate = totalSessions > 0 ? (sessionsAttended / totalSessions) * 100 : 0;
      const lateCount = data.sessions.filter(s => s.isLate).length;
      return {
        studentId,
        name: data.name,
        email: data.email,
        sessionsAttended,
        totalSessions,
        rate,
        lateCount,
        isAtRisk: rate < 70
      };
    });

    // Sort by rate descending by default
    studentStats.sort((a, b) => b.rate - a.rate);

    state.analyticsData = {
      totalSessions,
      uniqueStudents,
      avgAttendanceRate,
      sessionStats,
      studentStats,
      atRiskStudents: studentStats.filter(s => s.isAtRisk)
    };

    state.analyticsLoading = false;
    render();

    // Initialize charts after render
    setTimeout(() => {
      initAnalyticsCharts();
    }, 100);

  } catch (err) {
    console.error('Failed to load analytics:', err);
    state.analyticsLoading = false;
    state.analyticsData = null;
    render();
  }
}

function initAnalyticsCharts() {
  if (!state.analyticsData) return;

  const isDark = state.darkMode;
  const textColor = isDark ? '#e5e7eb' : '#374151';
  const gridColor = isDark ? '#374151' : '#e5e7eb';

  // Destroy existing charts if they exist
  if (state.trendChart) {
    state.trendChart.destroy();
    state.trendChart = null;
  }
  if (state.sessionChart) {
    state.sessionChart.destroy();
    state.sessionChart = null;
  }

  // Trend Chart
  const trendCanvas = document.getElementById('trendChart');
  if (trendCanvas) {
    const ctx = trendCanvas.getContext('2d');
    const data = state.analyticsData.sessionStats;

    state.trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(s => new Date(s.createdAt).toLocaleDateString()),
        datasets: [{
          label: 'Attendance Rate (%)',
          data: data.map(s => s.rate.toFixed(1)),
          borderColor: isDark ? '#818cf8' : '#4f46e5',
          backgroundColor: isDark ? 'rgba(129, 140, 248, 0.1)' : 'rgba(79, 70, 229, 0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: textColor }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: { color: textColor },
            grid: { color: gridColor }
          },
          x: {
            ticks: { color: textColor },
            grid: { color: gridColor }
          }
        }
      }
    });
  }

  // Session Comparison Chart
  const sessionCanvas = document.getElementById('sessionChart');
  if (sessionCanvas) {
    const ctx = sessionCanvas.getContext('2d');
    const data = state.analyticsData.sessionStats.slice(-10); // Last 10 sessions

    state.sessionChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.map(s => s.className.length > 15 ? s.className.substring(0, 15) + '...' : s.className),
        datasets: [{
          label: 'Students Present',
          data: data.map(s => s.attendanceCount),
          backgroundColor: isDark ? '#34d399' : '#10b981',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: textColor }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: textColor },
            grid: { color: gridColor }
          },
          x: {
            ticks: { color: textColor, maxRotation: 45 },
            grid: { color: gridColor }
          }
        }
      }
    });
  }
}

function sortAnalyticsTable(column) {
  if (state.analyticsSortColumn === column) {
    state.analyticsSortDirection = state.analyticsSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    state.analyticsSortColumn = column;
    state.analyticsSortDirection = column === 'name' ? 'asc' : 'desc';
  }

  const dir = state.analyticsSortDirection === 'asc' ? 1 : -1;
  state.analyticsData.studentStats.sort((a, b) => {
    if (column === 'name') {
      return dir * a.name.localeCompare(b.name);
    } else if (column === 'id') {
      return dir * a.studentId.localeCompare(b.studentId);
    } else if (column === 'sessions') {
      return dir * (a.sessionsAttended - b.sessionsAttended);
    } else if (column === 'rate') {
      return dir * (a.rate - b.rate);
    }
    return 0;
  });

  render();
}

function applyAnalyticsDateFilter() {
  const startDate = document.getElementById('analyticsStartDate').value;
  const endDate = document.getElementById('analyticsEndDate').value;
  state.analyticsDateStart = startDate;
  state.analyticsDateEnd = endDate;
  loadAnalyticsData();
}

function clearAnalyticsDateFilter() {
  state.analyticsDateStart = '';
  state.analyticsDateEnd = '';
  document.getElementById('analyticsStartDate').value = '';
  document.getElementById('analyticsEndDate').value = '';
  loadAnalyticsData();
}

function exportAnalyticsCSV() {
  if (!state.analyticsData) return;

  const { totalSessions, uniqueStudents, avgAttendanceRate, studentStats, sessionStats } = state.analyticsData;

  const lines = [];

  // Summary section
  lines.push(['NEU Attendance Analytics Report']);
  lines.push(['Generated:', new Date().toISOString()]);
  lines.push([]);
  lines.push(['Summary']);
  lines.push(['Total Sessions:', totalSessions]);
  lines.push(['Unique Students:', uniqueStudents]);
  lines.push(['Average Attendance Rate:', avgAttendanceRate.toFixed(1) + '%']);
  lines.push([]);

  // Student attendance section
  lines.push(['Student Attendance']);
  lines.push(['Student ID', 'Name', 'Email', 'Sessions Attended', 'Total Sessions', 'Attendance Rate', 'Late Count', 'At Risk']);
  for (const s of studentStats) {
    lines.push([
      s.studentId,
      s.name,
      s.email || '',
      s.sessionsAttended,
      s.totalSessions,
      s.rate.toFixed(1) + '%',
      s.lateCount,
      s.isAtRisk ? 'Yes' : 'No'
    ]);
  }
  lines.push([]);

  // Session breakdown section
  lines.push(['Session Breakdown']);
  lines.push(['Date', 'Class Name', 'Students Present', 'Attendance Rate']);
  for (const s of sessionStats) {
    lines.push([
      new Date(s.createdAt).toLocaleDateString(),
      s.className,
      s.attendanceCount,
      s.rate.toFixed(1) + '%'
    ]);
  }

  const BOM = '\uFEFF';
  const csv = BOM + lines.map(row => row.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'analytics_report_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
}

function renderAnalyticsView() {
  if (state.analyticsLoading) {
    return `
      <div class="flex items-center justify-center min-h-screen">
        <div class="text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 dark:border-indigo-400 mx-auto mb-4"></div>
          <p class="text-gray-600 dark:text-gray-300">Loading analytics...</p>
        </div>
      </div>`;
  }

  if (!state.analyticsData) {
    return `
      <div class="pt-8">
        <button onclick="state.showAnalytics = false; render();" class="mb-4 text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium no-print">‚Üê Back to Dashboard</button>
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center">
          <p class="text-gray-500 dark:text-gray-400">No analytics data available. Start some sessions first!</p>
        </div>
      </div>`;
  }

  const { totalSessions, uniqueStudents, avgAttendanceRate, studentStats, atRiskStudents, sessionStats } = state.analyticsData;
  const sortIcon = (col) => state.analyticsSortColumn === col
    ? (state.analyticsSortDirection === 'asc' ? ' ‚Üë' : ' ‚Üì')
    : '';

  return `
    <div class="pt-8 space-y-6">
      <div class="flex justify-between items-center no-print">
        <button onclick="state.showAnalytics = false; render();" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium">‚Üê Back to Dashboard</button>
        <h2 class="text-xl font-bold text-gray-800 dark:text-white">Analytics Dashboard</h2>
        <button onclick="exportAnalyticsCSV()" class="px-4 py-2 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 rounded-lg hover:bg-emerald-200 dark:hover:bg-emerald-900/50 font-medium text-sm">Export Report</button>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-3 gap-4">
        <div class="bg-indigo-50 dark:bg-indigo-900/30 rounded-xl p-6 text-center">
          <p class="text-3xl font-bold text-indigo-700 dark:text-indigo-400">${totalSessions}</p>
          <p class="text-sm text-indigo-600 dark:text-indigo-500">Total Sessions</p>
        </div>
        <div class="bg-emerald-50 dark:bg-emerald-900/30 rounded-xl p-6 text-center">
          <p class="text-3xl font-bold text-emerald-700 dark:text-emerald-400">${avgAttendanceRate.toFixed(1)}%</p>
          <p class="text-sm text-emerald-600 dark:text-emerald-500">Avg Attendance</p>
        </div>
        <div class="bg-purple-50 dark:bg-purple-900/30 rounded-xl p-6 text-center">
          <p class="text-3xl font-bold text-purple-700 dark:text-purple-400">${uniqueStudents}</p>
          <p class="text-sm text-purple-600 dark:text-purple-500">Unique Students</p>
        </div>
      </div>

      <!-- Date Filter -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-4">
        <div class="flex flex-wrap items-center gap-4">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Filter by Date:</span>
          <input type="date" id="analyticsStartDate" value="${state.analyticsDateStart}"
            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
          <span class="text-gray-500">to</span>
          <input type="date" id="analyticsEndDate" value="${state.analyticsDateEnd}"
            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
          <button onclick="applyAnalyticsDateFilter()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium">Apply</button>
          <button onclick="clearAnalyticsDateFilter()" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 text-sm font-medium">Clear</button>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Attendance Trend</h3>
          <div style="height: 250px;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Session Comparison (Last 10)</h3>
          <div style="height: 250px;">
            <canvas id="sessionChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Student Rankings -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Student Attendance Ranking</h3>
        ${studentStats.length === 0
          ? '<p class="text-gray-400 dark:text-gray-500 text-center py-6">No student data</p>'
          : `
            <div class="overflow-x-auto max-h-80 overflow-y-auto">
              <table class="w-full text-sm">
                <thead class="sticky top-0 bg-white dark:bg-gray-800">
                  <tr class="border-b dark:border-gray-700">
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium cursor-pointer hover:text-indigo-600" onclick="sortAnalyticsTable('name')">Name${sortIcon('name')}</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium cursor-pointer hover:text-indigo-600" onclick="sortAnalyticsTable('id')">Student ID${sortIcon('id')}</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium cursor-pointer hover:text-indigo-600" onclick="sortAnalyticsTable('sessions')">Sessions${sortIcon('sessions')}</th>
                    <th class="text-left py-2 text-gray-500 dark:text-gray-400 font-medium cursor-pointer hover:text-indigo-600" onclick="sortAnalyticsTable('rate')">Rate${sortIcon('rate')}</th>
                  </tr>
                </thead>
                <tbody>
                  ${studentStats.map(s => `
                    <tr class="border-b border-gray-100 dark:border-gray-700 ${s.isAtRisk ? 'bg-red-50 dark:bg-red-900/20' : ''}">
                      <td class="py-2 ${s.isAtRisk ? 'text-red-700 dark:text-red-400 font-medium' : 'text-gray-800 dark:text-gray-200'}">${escapeHtml(s.name)}</td>
                      <td class="py-2 font-mono ${s.isAtRisk ? 'text-red-600 dark:text-red-400' : 'text-gray-500 dark:text-gray-400'}">${escapeHtml(s.studentId)}</td>
                      <td class="py-2 ${s.isAtRisk ? 'text-red-600 dark:text-red-400' : 'text-gray-500 dark:text-gray-400'}">${s.sessionsAttended}/${s.totalSessions}</td>
                      <td class="py-2">
                        <span class="px-2 py-1 rounded text-xs font-medium ${
                          s.rate >= 90 ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400' :
                          s.rate >= 70 ? 'bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400' :
                          'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'
                        }">${s.rate.toFixed(1)}%</span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `
        }
      </div>

      <!-- At-Risk Students -->
      ${atRiskStudents.length > 0 ? `
        <div class="bg-red-50 dark:bg-red-900/20 rounded-2xl shadow-xl p-6 border-l-4 border-red-500">
          <h3 class="text-lg font-semibold text-red-800 dark:text-red-300 mb-4">At-Risk Students (Below 70%)</h3>
          <p class="text-sm text-red-600 dark:text-red-400 mb-4">${atRiskStudents.length} student${atRiskStudents.length > 1 ? 's' : ''} need attention</p>
          <div class="space-y-2">
            ${atRiskStudents.map(s => `
              <div class="flex justify-between items-center bg-white dark:bg-gray-800 rounded-lg p-3">
                <div>
                  <span class="font-medium text-gray-800 dark:text-gray-200">${escapeHtml(s.name)}</span>
                  <span class="text-gray-500 dark:text-gray-400 ml-2">(${escapeHtml(s.studentId)})</span>
                </div>
                <span class="px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-full text-sm font-medium">${s.rate.toFixed(1)}%</span>
              </div>
            `).join('')}
          </div>
        </div>
      ` : `
        <div class="bg-emerald-50 dark:bg-emerald-900/20 rounded-2xl shadow-xl p-6 border-l-4 border-emerald-500">
          <h3 class="text-lg font-semibold text-emerald-800 dark:text-emerald-300 mb-2">All Students Above 70%</h3>
          <p class="text-sm text-emerald-600 dark:text-emerald-400">Great news! No at-risk students detected.</p>
        </div>
      `}
    </div>`;
}

function init() {
  loadDarkMode();

  // Update QR code availability status
  state.qrCodeAvailable = isQRCodeAvailable();
  if (!state.qrCodeAvailable) {
    console.warn('QRCode library did not load from any CDN. QR codes will show fallback message.');
  }

  const params = getUrlParams();
  if (params.mode === 'teacher' || params.mode === 'student' || params.mode === 'lookup') {
    state.mode = params.mode;
    render();
    if (params.mode === 'student') {
      acquireStudentLocation();
      initDeviceId();
      // Load saved student info
      state.savedStudentInfo = loadStudentInfo();
      state.showSavedInfoBanner = !!state.savedStudentInfo;
      render();
    }
    // For teacher mode, PIN will be required first, then recovery happens
  } else {
    render();
    setTimeout(generateModeQRCodes, 100);
  }
  updateOnlineStatus();
}

window.addEventListener('popstate', () => {
  const params = getUrlParams();
  state.mode = params.mode || null;
  state.pinVerified = false;
  render();
});

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && state.mode === 'teacher' && state.session) {
    const elapsed = Math.floor((Date.now() - state.session.codeGeneratedAt) / 1000);
    const newTimeLeft = CODE_REFRESH_SECONDS - (elapsed % CODE_REFRESH_SECONDS);
    state.timeLeft = newTimeLeft > 0 ? newTimeLeft : CODE_REFRESH_SECONDS;
    render();
  }
});

init();
</script>
</body>
</html>

{
  "rules": {
    "config": {
      ".read": true,
      ".write": "auth != null && root.child('instructors').child(auth.uid).exists()"
    },

    "instructors": {
      ".read": true,
      "$uid": {
        ".write": "auth != null && auth.uid === $uid && root.child('config/instructorEmails').val().contains(auth.token.email)"
      }
    },

    "activeSession": {
      ".read": true,
      ".write": "auth != null && root.child('instructors').child(auth.uid).exists()"
    },

    "sessions": {
      ".read": true,
      ".indexOn": ["scheduledFor", "status"],
      "$sessionId": {
        ".write": "auth != null && root.child('instructors').child(auth.uid).exists()",
        ".validate": "newData.hasChildren(['className', 'createdAt', 'active'])",

        "id": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
        },
        "className": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
        },
        "radius": {
          ".validate": "newData.isNumber() && newData.val() >= 10 && newData.val() <= 500"
        },
        "code": {
          ".validate": "newData.isString() && newData.val().length == 6 && newData.val().matches(/^[A-Z0-9]+$/)"
        },
        "previousCode": {
          ".validate": "newData.isString() && newData.val().length == 6 && newData.val().matches(/^[A-Z0-9]+$/)"
        },
        "location": {
          ".validate": "newData.hasChildren(['lat', 'lng'])",
          "lat": {
            ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90"
          },
          "lng": {
            ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180"
          }
        },
        "codeGeneratedAt": {
          ".validate": "newData.isNumber()"
        },
        "codeRotationInterval": {
          ".validate": "newData.isNumber() && newData.val() >= 30 && newData.val() <= 600"
        },
        "createdAt": {
          ".validate": "newData.isString()"
        },
        "active": {
          ".validate": "newData.isBoolean()"
        },
        "lateThresholdMinutes": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 60"
        },
        "lateThreshold": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 60"
        },
        "endedAt": {
          ".validate": "newData.isString()"
        },
        "attendanceCount": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "lateCount": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "isReopened": {
          ".validate": "newData.isBoolean()"
        },
        "reopenedAt": {
          ".validate": "newData.isString()"
        },
        "scheduledFor": {
          ".validate": "newData.isString()"
        },
        "status": {
          ".validate": "newData.isString()"
        },
        "courseId": {
          ".validate": "newData.isString()"
        },
        "radiusOverride": {
          ".validate": "newData.isNumber()"
        },
        "lateThresholdOverride": {
          ".validate": "newData.isNumber()"
        }
      }
    },

    "attendance": {
      ".read": true,
      "$sessionId": {
        ".read": true,
        "$recordId": {
          ".write": "(auth != null && !data.exists()) || (auth != null && root.child('instructors').child(auth.uid).exists())",
          ".validate": "newData.hasChildren(['studentId', 'studentName', 'email', 'deviceId', 'timestamp'])",

          "studentId": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 20"
          },
          "studentName": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
          },
          "email": {
            ".validate": "newData.isString() && newData.val().contains('@')"
          },
          "deviceId": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
          },
          "uid": {
            ".validate": "newData.isString()"
          },
          "location": {
            ".validate": "newData.hasChildren(['lat', 'lng'])",
            "lat": {
              ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90"
            },
            "lng": {
              ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180"
            }
          },
          "distance": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          },
          "manuallyApproved": {
            ".validate": "newData.isBoolean()"
          },
          "participation": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "isLate": {
            ".validate": "newData.isBoolean()"
          },
          "noGps": {
            ".validate": "newData.isBoolean()"
          },
          "allowedRadius": {
            ".validate": "newData.isNumber()"
          },
          "lateCheckIn": {
            ".validate": "newData.isBoolean()"
          },
          "locationProvided": {
            ".validate": "newData.isBoolean()"
          }
        }
      }
    },

    "failed": {
      ".read": true,
      "$sessionId": {
        ".read": true,
        "$recordId": {
          ".write": "auth != null",
          ".validate": "!newData.exists() || newData.hasChildren(['studentId', 'studentName', 'email', 'deviceId', 'reason', 'timestamp'])",

          "studentId": {
            ".validate": "newData.isString() && newData.val().length <= 20"
          },
          "studentName": {
            ".validate": "newData.isString() && newData.val().length <= 100"
          },
          "email": {
            ".validate": "newData.isString()"
          },
          "uid": {
            ".validate": "newData.isString()"
          },
          "deviceId": {
            ".validate": "newData.isString()"
          },
          "location": {
            ".validate": "newData.hasChildren(['lat', 'lng'])",
            "lat": {
              ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90"
            },
            "lng": {
              ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180"
            }
          },
          "distance": {
            ".validate": "newData.isNumber()"
          },
          "allowedRadius": {
            ".validate": "newData.isNumber()"
          },
          "reason": {
            ".validate": "newData.isString()"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          },
          "noGps": {
            ".validate": "newData.isBoolean()"
          }
        }
      }
    },

    "audit": {
      ".read": "auth != null && root.child('instructors').child(auth.uid).exists()",
      "$sessionId": {
        "$recordId": {
          ".write": "auth != null && root.child('instructors').child(auth.uid).exists()",
          ".validate": "newData.hasChildren(['action', 'studentId', 'timestamp'])",

          "action": {
            ".validate": "newData.isString()"
          },
          "studentId": {
            ".validate": "newData.isString()"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          }
        }
      }
    },

    "courses": {
      ".read": true,
      "$courseId": {
        ".write": "auth != null && root.child('instructors').child(auth.uid).exists()"
      }
    },

    "$other": {
      ".read": false,
      ".write": false
    }
  }
}

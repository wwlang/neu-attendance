{
  "rules": {
    // Configuration - readable by all, writable by instructors
    "config": {
      ".read": true,
      ".write": "auth != null && root.child('instructors').child(auth.uid).exists()"
    },

    // Instructors registry - users can add themselves if their email is in allowed list
    "instructors": {
      ".read": true,
      "$uid": {
        ".write": "auth != null && auth.uid === $uid && root.child('config/instructorEmails').val().contains(auth.token.email)"
      }
    },

    // Active session pointer
    "activeSession": {
      ".read": true,
      ".write": "auth != null && root.child('instructors').child(auth.uid).exists()"
    },

    // Sessions - anyone can read, only instructors can write
    "sessions": {
      ".read": true,
      "$sessionId": {
        ".write": "auth != null && root.child('instructors').child(auth.uid).exists()",
        ".validate": "newData.hasChildren(['id', 'className', 'location', 'radius', 'code', 'codeGeneratedAt', 'createdAt', 'active'])",

        "id": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
        },
        "className": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
        },
        "radius": {
          ".validate": "newData.isNumber() && newData.val() >= 10 && newData.val() <= 500"
        },
        "code": {
          ".validate": "newData.isString() && newData.val().length == 6 && newData.val().matches(/^[A-Z0-9]+$/)"
        },
        "location": {
          ".validate": "newData.hasChildren(['lat', 'lng'])",
          "lat": {
            ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90"
          },
          "lng": {
            ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180"
          }
        },
        "codeGeneratedAt": {
          ".validate": "newData.isNumber()"
        },
        "createdAt": {
          ".validate": "newData.isString()"
        },
        "active": {
          ".validate": "newData.isBoolean()"
        },
        "codeRotationInterval": {
          ".validate": "newData.isNumber() && newData.val() >= 30 && newData.val() <= 600"
        },
        "lateThresholdMinutes": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 60"
        },
        "lateThreshold": {
          ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= 60"
        }
      }
    },

    // Attendance records - authenticated users can create their own record once per session
    "attendance": {
      ".read": true,
      "$sessionId": {
        ".read": true,
        "$oderedId": {
          // Students can create new records, instructors can update any record
          ".write": "(auth != null && !data.exists()) || (auth != null && root.child('instructors').child(auth.uid).exists())",
          ".validate": "newData.hasChildren(['studentId', 'studentName', 'email', 'deviceId', 'location', 'distance', 'timestamp'])",

          "studentId": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 20"
          },
          "studentName": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
          },
          "email": {
            ".validate": "newData.isString() && newData.val().matches(/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/)"
          },
          "deviceId": {
            ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50"
          },
          "uid": {
            ".validate": "newData.isString()"
          },
          "location": {
            ".validate": "newData.hasChildren(['lat', 'lng'])",
            "lat": {
              ".validate": "newData.isNumber() && newData.val() >= -90 && newData.val() <= 90"
            },
            "lng": {
              ".validate": "newData.isNumber() && newData.val() >= -180 && newData.val() <= 180"
            }
          },
          "distance": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          },
          "manuallyApproved": {
            ".validate": "newData.isBoolean()"
          },
          "participation": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "isLate": {
            ".validate": "newData.isBoolean()"
          }
        }
      }
    },

    // Failed attempts - authenticated users can create, instructors can delete
    "failed": {
      ".read": true,
      "$sessionId": {
        ".read": true,
        "$recordId": {
          ".write": "auth != null",
          ".validate": "!newData.exists() || newData.hasChildren(['studentId', 'studentName', 'email', 'deviceId', 'location', 'distance', 'reason', 'allowedRadius', 'timestamp'])",

          "studentId": {
            ".validate": "newData.isString() && newData.val().length <= 20"
          },
          "studentName": {
            ".validate": "newData.isString() && newData.val().length <= 100"
          },
          "email": {
            ".validate": "newData.isString()"
          },
          "uid": {
            ".validate": "newData.isString()"
          },
          "distance": {
            ".validate": "newData.isNumber()"
          },
          "allowedRadius": {
            ".validate": "newData.isNumber()"
          },
          "reason": {
            ".validate": "newData.isString()"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          }
        }
      }
    },

    // Audit trail - instructors only
    "audit": {
      ".read": "auth != null && root.child('instructors').child(auth.uid).exists()",
      "$sessionId": {
        "$recordId": {
          ".write": "auth != null && root.child('instructors').child(auth.uid).exists()",
          ".validate": "newData.hasChildren(['action', 'studentId', 'timestamp'])",

          "action": {
            ".validate": "newData.isString() && (newData.val() == 'manual_approve' || newData.val() == 'increment_participation' || newData.val() == 'decrement_participation')"
          },
          "studentId": {
            ".validate": "newData.isString()"
          },
          "timestamp": {
            ".validate": "newData.isNumber()"
          }
        }
      }
    },

    // Deny all other paths
    "$other": {
      ".read": false,
      ".write": false
    }
  }
}
